

<h3><strong>Introduction</strong></h3>

<p><a href="https://github.com/odzhan/tinycrypt/blob/master/block/sm4/doc/329.pdf">SM4</a> (formerly SMS4) is a 128-bit block cipher with support for 128-bit keys. It's used in the WLAN Authentication and Privacy Infrastructure (WAPI), a Chinese WLAN national standard. It was published (or declassified) in 2006 and standardized in 2012. SM means commercial cipher. The full list of cryptographic standards for commercial purposes are as follows.</p>

<ul>
<li><a href="https://tools.ietf.org/html/draft-sca-cfrg-sm3-02">SM2</a> - Elliptic curve algorithms for digital signatures and key exchange.</li>
<li><a href="https://tools.ietf.org/html/draft-sca-cfrg-sm3-02">SM3</a> - A cryptographic hash.</li>
<li><a href="https://tools.ietf.org/id/draft-ribose-cfrg-sm4-09.html">SM4</a> - A block cipher.</li>
<li><a href="https://eprint.iacr.org/2017/117">SM9</a> - A set of identity-based cryptographic schemes from pairings.</li> 
</ul>

<h3><strong>About the C code</strong></h3>

<p>If you want high performance implementations of SM4 in C and x86/x86-x64 assembly, please look at <a href="http://gmssl.org/">GMSSL</a> which appears to be a fork of OpenSSL that includes SM2, SM3, SM4 and SM9.</p>

<h3><strong>Compact code</strong></h3>

<p>This version combines the key scheduling and encryption in one call. The sbox values are generated on the fly.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> R</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>32</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> F</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>b</span><span style='color:#808030; '>)</span><span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>0</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>&lt;</span><span style='color:#004a43; '>b</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> X</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>y</span><span style='color:#808030; '>)</span><span style='color:#004a43; '>t</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>y</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>y</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>t</span><span style='color:#808030; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> B<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> W<span style='color:#800080; '>;</span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> rev __builtin_bswap32</span>

B A<span style='color:#808030; '>(</span>B x<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>     
    B m<span style='color:#808030; '>=</span><span style='color:#008000; '>0xA7</span><span style='color:#808030; '>,</span>s<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>t<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>do</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>t<span style='color:#808030; '>=</span>x<span style='color:#808030; '>&amp;</span>m<span style='color:#800080; '>;</span>t<span style='color:#800080; '>;</span>t<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>t<span style='color:#808030; '>&amp;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      s<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>s<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span><span style='color:#808030; '>(</span>s<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      m<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>m<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span><span style='color:#808030; '>(</span>m<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>while</span><span style='color:#808030; '>(</span>m<span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#008000; '>0xA7</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>return</span> s<span style='color:#808030; '>^</span><span style='color:#008000; '>0xD3</span><span style='color:#800080; '>;</span> 
<span style='color:#800080; '>}</span>

B S<span style='color:#808030; '>(</span>B x<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    B i<span style='color:#808030; '>,</span> c<span style='color:#808030; '>,</span> y<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>// affine transformation</span>
    x <span style='color:#808030; '>=</span> A<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>// multiplicative inverse</span>
    <span style='color:#696969; '>// uses x^8 + x^7 + x^6 + x^5 + x^4 + x^2 + 1 as IRP</span>
    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span>i<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>y<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span><span style='color:#808030; '>-</span><span style='color:#808030; '>-</span>i<span style='color:#800080; '>;</span>y<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>c<span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>y<span style='color:#808030; '>=</span><span style='color:#808030; '>=</span>x<span style='color:#808030; '>)</span><span style='color:#800080; '>?</span>c<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>:</span>y<span style='color:#808030; '>,</span>y<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#008000; '>0xF5</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      x<span style='color:#808030; '>=</span>y<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>// affine transformation</span>
    <span style='color:#800000; font-weight:bold; '>return</span> A<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>void</span> sm4<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>mk<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>data<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    W <span style='color:#808030; '>*</span>p<span style='color:#808030; '>,</span>c<span style='color:#808030; '>,</span>i<span style='color:#808030; '>,</span>j<span style='color:#808030; '>,</span>s<span style='color:#808030; '>,</span>t<span style='color:#808030; '>,</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
    W fk<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#800080; '>{</span><span style='color:#008000; '>0xa3b1bac6</span><span style='color:#808030; '>,</span><span style='color:#008000; '>0x56aa3350</span><span style='color:#808030; '>,</span><span style='color:#008000; '>0x677d9197</span><span style='color:#808030; '>,</span><span style='color:#008000; '>0xb27022dc</span><span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>// load the 128-bit key and 128-bit plaintext</span>
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span>x<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>rev<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>W<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>mk<span style='color:#808030; '>)</span><span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span>fk<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>x<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>rev<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>W<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>data<span style='color:#808030; '>)</span><span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#696969; '>// encrypt plaintext</span>
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#696969; '>// calculate round constant</span>
      F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span>c<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>,</span>c<span style='color:#808030; '>|</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>j<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>s<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span><span style='color:#808030; '>)</span>s<span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>s<span style='color:#808030; '>-</span><span style='color:#808030; '>-</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        p<span style='color:#808030; '>=</span><span style='color:#808030; '>&amp;</span>x<span style='color:#808030; '>[</span>s<span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>// add round constant or sub key</span>
        c<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>p<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>p<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>p<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>// non-linear layer</span>
        F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span>c<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>&amp;</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span>S<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>c<span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#696969; '>// linear layer</span>
        c<span style='color:#808030; '>=</span>p<span style='color:#808030; '>[</span>i<span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>c<span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>s<span style='color:#808030; '>)</span><span style='color:#800080; '>?</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>19</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>9</span><span style='color:#808030; '>)</span><span style='color:#800080; '>:</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>22</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>14</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span>R<span style='color:#808030; '>(</span>c<span style='color:#808030; '>,</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#696969; '>// store ciphertext</span>
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>W<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>data<span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>-</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>rev<span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>x86 assembly</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>; -----------------------------------------------</span>
<span style='color:#696969; '>; SM4 block cipher in x86 assembly (encryption only)</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; size: 276 bytes</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; global calls use cdecl convention</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; -----------------------------------------------</span>

    <span style='color:#004a43; '>bits</span> <span style='color:#008c00; '>32</span>
    
<span style='color:#004a43; '>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43; '>%ifndef</span><span style='color:#004a43; '> BIN</span>
      <span style='color:#004a43; '>global</span> sm4
<span style='color:#004a43; '>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43; '>%endif</span>
    
<span style='color:#e34adc; '>sm4:</span>
    <span style='color:#800000; font-weight:bold; '>pushad</span>                     <span style='color:#696969; '>; save registers</span>
    <span style='color:#800000; font-weight:bold; '>pushad</span>                     <span style='color:#696969; '>; allocate 32 bytes for key+plaintext</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>esp</span>            <span style='color:#696969; '>; edi = x</span>
    <span style='color:#696969; '>; W fk[4]={0xa3b1bac6,0x56aa3350,0x677d9197,0xb27022dc};</span>
    <span style='color:#696969; '>; F(i,4)x[i+4]=rev(((W*)mk)[i])^fk[i],x[i]=rev(((W*)in)[i]);</span>
    <span style='color:#800000; font-weight:bold; '>push</span>   <span style='color:#008c00; '>2</span>
    <span style='color:#800000; font-weight:bold; '>pop</span>    <span style='color:#000080; '>ecx</span>
    <span style='color:#696969; '>; load the 128-bit key and 128-bit plaintext</span>
<span style='color:#e34adc; '>sm_L0:</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>64</span><span style='color:#008c00; '>+4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>ecx</span><span style='color:#808030; '>]</span> <span style='color:#696969; '>; esi = mk or data</span>
    <span style='color:#800000; font-weight:bold; '>push</span>   <span style='color:#000080; '>ecx</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>cl</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>4</span>
<span style='color:#e34adc; '>sm_L1:</span>
    <span style='color:#800000; font-weight:bold; '>lodsd</span>                      <span style='color:#696969; '>; eax = mk[i] or data[i]</span>
    <span style='color:#800000; font-weight:bold; '>bswap</span>  <span style='color:#000080; '>eax</span>                 <span style='color:#696969; '>; reverse byte order</span>
    <span style='color:#800000; font-weight:bold; '>stosd</span>                      <span style='color:#696969; '>; x[i]=eax</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sm_L1</span>
    <span style='color:#800000; font-weight:bold; '>pop</span>    <span style='color:#000080; '>ecx</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sm_L0</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ecx</span>            <span style='color:#696969; '>; i = 0</span>
    
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xa3b1bac6</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>12</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x56aa3350</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>-</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x677d9197</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>-</span> <span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xb27022dc</span>
    <span style='color:#696969; '>; F(j,4)c|=((((i*4)+j)*7)&amp;255),c=R(c,8);</span>
    <span style='color:#696969; '>; calculate round constant</span>
<span style='color:#e34adc; '>sm_L2:</span>
    <span style='color:#800000; font-weight:bold; '>push</span>   <span style='color:#008c00; '>4</span>                   <span style='color:#696969; '>; j = 4</span>
    <span style='color:#800000; font-weight:bold; '>pop</span>    <span style='color:#000080; '>ecx</span>
    <span style='color:#800000; font-weight:bold; '>cdq</span>                        <span style='color:#696969; '>; c = 0</span>
<span style='color:#e34adc; '>sm_L3:</span>
    <span style='color:#800000; font-weight:bold; '>lea</span>    <span style='color:#000080; '>ebx</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>+</span><span style='color:#000080; '>ecx</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span>  <span style='color:#696969; '>; ebx = (i*4) + (j-1)</span>
    <span style='color:#800000; font-weight:bold; '>imul</span>   <span style='color:#000080; '>ebx</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ebx</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>7</span>         <span style='color:#696969; '>; ebx *= 7</span>
    <span style='color:#800000; font-weight:bold; '>or</span>     <span style='color:#000080; '>dl</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>bl</span>              <span style='color:#696969; '>; c |= ebx % 256</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>8</span>              <span style='color:#696969; '>; c = R(c, 8)</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sm_L3</span>
    <span style='color:#800000; font-weight:bold; '>lea</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>]</span>
<span style='color:#e34adc; '>sm_L4:</span>
    <span style='color:#800000; font-weight:bold; '>sub</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>16</span>             <span style='color:#696969; '>; p = &amp;x[s*4]</span>
    <span style='color:#696969; '>; add round constant or sub key</span>
    <span style='color:#696969; '>; c ^= p[(i+1)%4] ^ p[(i+2)%4] ^ p[(i+3)%4];</span>
    <span style='color:#800000; font-weight:bold; '>lea</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span>        <span style='color:#696969; '>; c ^= p[(i+1)%4]</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>]</span>
    <span style='color:#800000; font-weight:bold; '>lea</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span>        <span style='color:#696969; '>; c ^= p[(i+2)%4]</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>]</span>
    <span style='color:#800000; font-weight:bold; '>lea</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span>        <span style='color:#696969; '>; c ^= p[(i+3)%4]</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>]</span>
    <span style='color:#696969; '>; non-linear layer</span>
    <span style='color:#696969; '>; F(j,4)c=(c&amp;-256)|S(c),c=R(c,8);</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>cl</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>4</span>
<span style='color:#e34adc; '>sm_L5:</span>
    <span style='color:#800000; font-weight:bold; '>call</span>   <span style='color:#e34adc; '>S</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>8</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sm_L5</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>
    <span style='color:#696969; '>; linear layer</span>
    <span style='color:#696969; '>; c = p[i%4] ^= c ^ ((s) ? R(c,19)^R(c,9) : R(c,30)^R(c,22)^R(c,14)^R(c,8));</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>ebp</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>
    <span style='color:#696969; '>; for key setup</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>19</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>ebp</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>9</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>esp</span>
    <span style='color:#800000; font-weight:bold; '>jnz</span>    <span style='color:#e34adc; '>sm_L6</span>
    <span style='color:#696969; '>; for encryption</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>30</span><span style='color:#008c00; '>-19</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>ebp</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>22</span><span style='color:#008c00; '>-9</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edi</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ebp</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#008c00; '>-30</span><span style='color:#808030; '>)</span><span style='color:#008c00; '>+14</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>ebp</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#008c00; '>-22</span><span style='color:#808030; '>)</span><span style='color:#008c00; '>+8</span>
<span style='color:#e34adc; '>sm_L6:</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edi</span>           <span style='color:#696969; '>; t^= R(t, 30) or R(t, 19)</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ebp</span>           <span style='color:#696969; '>; t^= R(t, 22) or R(t,  9)</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>eax</span>           <span style='color:#696969; '>; ebx = i % 4</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>edx</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>]</span>   <span style='color:#696969; '>; t ^= p[i%4]</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#808030; '>[</span><span style='color:#000080; '>esi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>   <span style='color:#696969; '>; p[i%4] = t</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>esp</span>
    <span style='color:#800000; font-weight:bold; '>jnz</span>    <span style='color:#e34adc; '>sm_L4</span>
    
    <span style='color:#800000; font-weight:bold; '>inc</span>    <span style='color:#000080; '>eax</span>                <span style='color:#696969; '>; i++</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>32</span>             <span style='color:#696969; '>; i&lt;32</span>
    <span style='color:#800000; font-weight:bold; '>jnz</span>    <span style='color:#e34adc; '>sm_L2</span>

    <span style='color:#696969; '>; store ciphertext</span>
    <span style='color:#696969; '>; F(i,4)((W*)data)[3-i]=rev(x[i]);</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>64</span><span style='color:#008c00; '>+8</span><span style='color:#808030; '>]</span>     <span style='color:#696969; '>; edi = data</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>cl</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>4</span>
<span style='color:#e34adc; '>sm_L7:</span>
    <span style='color:#800000; font-weight:bold; '>lodsd</span>                      <span style='color:#696969; '>; eax = x[0]</span>
    <span style='color:#800000; font-weight:bold; '>bswap</span>  <span style='color:#000080; '>eax</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#808030; '>[</span><span style='color:#000080; '>edi</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#000080; '>ecx</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>eax</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sm_L7</span>
    <span style='color:#800000; font-weight:bold; '>popad</span>                      <span style='color:#696969; '>; release memory</span>
    <span style='color:#800000; font-weight:bold; '>popad</span>                      <span style='color:#696969; '>; restore registers</span>
    <span style='color:#800000; font-weight:bold; '>ret</span>


    <span style='color:#696969; '>; *****************************</span>
    <span style='color:#696969; '>; B S(B x)</span>
    <span style='color:#696969; '>; *****************************</span>
<span style='color:#e34adc; '>S:</span>  
    <span style='color:#800000; font-weight:bold; '>pushad</span>
    <span style='color:#696969; '>; affine transformation</span>
    <span style='color:#696969; '>; x = A(x);</span>
    <span style='color:#800000; font-weight:bold; '>call</span>   <span style='color:#e34adc; '>A</span>
    <span style='color:#696969; '>; multiplicative inverse</span>
    <span style='color:#696969; '>; uses x^8 + x^7 + x^6 + x^5 + x^4 + x^2 + 1 as IRP</span>
    <span style='color:#800000; font-weight:bold; '>test</span>   <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>al</span>            <span style='color:#696969; '>; if(x){</span>
    <span style='color:#800000; font-weight:bold; '>jz</span>     <span style='color:#e34adc; '>sb_l6</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>edx</span>          <span style='color:#696969; '>; dl = x</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>cl</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>-1</span>            <span style='color:#696969; '>; i=255 </span>
<span style='color:#696969; '>; for(c=i=0,y=1;--i;y=(!c&amp;&amp;y==x)?c=1:y,y^=(y&lt;&lt;1)^((-(y>>7))&amp;0xF5));</span>
<span style='color:#e34adc; '>sb_l0:</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>             <span style='color:#696969; '>; y=1</span>
<span style='color:#e34adc; '>sb_l1:</span>
    <span style='color:#800000; font-weight:bold; '>test</span>   <span style='color:#000080; '>ah</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ah</span>            <span style='color:#696969; '>; !c</span>
    <span style='color:#800000; font-weight:bold; '>jnz</span>    <span style='color:#e34adc; '>sb_l2</span>    
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>dl</span>            <span style='color:#696969; '>; y!=x</span>
    <span style='color:#800000; font-weight:bold; '>setz</span>   <span style='color:#000080; '>ah</span>
    <span style='color:#800000; font-weight:bold; '>jz</span>     <span style='color:#e34adc; '>sb_l0</span>
<span style='color:#e34adc; '>sb_l2:</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>bl</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>al</span>            <span style='color:#696969; '>; y^=(y&lt;&lt;1)^((-(y>>7))&amp;0xF5)</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    <span style='color:#000080; '>bl</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>bl</span>
    <span style='color:#800000; font-weight:bold; '>sbb</span>    <span style='color:#000080; '>bh</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>bh</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>bh</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF5</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>bl</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>bh</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>bl</span>
    <span style='color:#800000; font-weight:bold; '>loop</span>   <span style='color:#e34adc; '>sb_l1</span>             <span style='color:#696969; '>; --i</span>
<span style='color:#e34adc; '>sb_l6:</span>
    <span style='color:#696969; '>; affine transformation</span>
    <span style='color:#800000; font-weight:bold; '>call</span>   <span style='color:#e34adc; '>A</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>28</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>al</span>
    <span style='color:#800000; font-weight:bold; '>popad</span>
    <span style='color:#800000; font-weight:bold; '>ret</span>

<span style='color:#e34adc; '>A:</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>dl</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>al</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>ah</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA7</span>           <span style='color:#696969; '>; m = 0xA7</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>al</span>             <span style='color:#696969; '>; s = 0</span>
<span style='color:#e34adc; '>ax_L0:</span>
    <span style='color:#696969; '>; for(t=x&amp;m;t!=0;t>>=1)s^=(t&amp;1);</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>dh</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>dl</span>             <span style='color:#696969; '>; t = x &amp; m</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>dh</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>ah</span>
<span style='color:#e34adc; '>ax_L1:</span>
    <span style='color:#800000; font-weight:bold; '>test</span>   <span style='color:#000080; '>dh</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>dh</span>             <span style='color:#696969; '>; t!=0</span>
    <span style='color:#800000; font-weight:bold; '>jz</span>     <span style='color:#e34adc; '>ax_L2</span>
    <span style='color:#800000; font-weight:bold; '>shr</span>    <span style='color:#000080; '>dh</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>              <span style='color:#696969; '>; t>>=1</span>
    <span style='color:#800000; font-weight:bold; '>jnc</span>    <span style='color:#e34adc; '>ax_L1</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>jmp</span>    <span style='color:#e34adc; '>ax_L1</span>
<span style='color:#e34adc; '>ax_L2:</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>              <span style='color:#696969; '>; s = (s>>1) | (s&lt;&lt;7);</span>
    <span style='color:#800000; font-weight:bold; '>rol</span>    <span style='color:#000080; '>ah</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>              <span style='color:#696969; '>; m = (m&lt;&lt;1) | (m>>7);</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>ah</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA7</span>           <span style='color:#696969; '>; while(m != 0xA7);</span>
    <span style='color:#800000; font-weight:bold; '>jne</span>    <span style='color:#e34adc; '>ax_L0</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD3</span>           <span style='color:#696969; '>; return s ^ 0xD3</span>
    <span style='color:#800000; font-weight:bold; '>ret</span>
</pre>

<h3><strong>Mixer-substitution T</strong></h3>

<p>T is a substitution that generates 32 bits of output from 32 bits of input using either a non-linear or linear function. Source code includes the full 256-byte array which obviously increases the size of code considerably. There is a way to generate the sbox values dynamically.</p>

<ul><li><strong>Non-Linear function</strong></li></ul>

$latex (b_0, b_1, b_2, b_3) = \tau (A) = (Sbox(a_0),Sbox(a_1),Sbox(a_2),Sbox(a_3))&amp;s=2$

<p>The S-box is a 256-byte array created using a function similar to AES.</p>

<img src="https://tinycrypt.files.wordpress.com/2017/02/sbox.png" alt="sbox" width="640" height="379" class="aligncenter size-full wp-image-1757" />

<ul><li><strong>Linear function (for key setup)</strong></li></ul>

$latex L'(B) = B \oplus (B \lll 13)\oplus (B \lll 23)&amp;s=2$

<ul><li><strong>Linear function (for encryption)</strong></li></ul>

$latex C=L(B)=B\oplus(B\lll 2)\oplus (B\lll 10)\oplus (B\lll 18)\oplus(B\lll 24)&amp;s=1$

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>static</span> <span style='color:#800000;font-weight:bold;'>const</span> uint8_t S<span style='color:#808030;'>[</span><span style='color:#008c00;'>256</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#800080;'>{</span>
  <span style='color:#008000;'>0xd6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x90</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfe</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xcc</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb7</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x16</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x14</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x28</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfb</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x05</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x2b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x67</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x76</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbe</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x04</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc3</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0xaa</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x44</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x13</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x26</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x49</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x86</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x06</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x99</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x9c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x42</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x50</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x91</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xef</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x98</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7a</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x33</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x54</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x43</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xed</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xcf</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xac</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x62</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xe4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x08</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x95</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x80</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xdf</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfa</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x75</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa6</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x47</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x07</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfc</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x73</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x17</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xba</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x83</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x59</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x19</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa8</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x68</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x81</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x71</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x64</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xda</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8b</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0xf8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xeb</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x70</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x56</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x35</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x1e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x24</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x63</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x58</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa2</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x25</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x22</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x21</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x78</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x87</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xd4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x00</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x46</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x57</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x27</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x52</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x4c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x36</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x02</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9e</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xea</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbf</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x40</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x38</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb5</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0xa3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xce</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x61</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x15</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa1</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xe0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xae</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x34</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x55</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0xad</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x93</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x32</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x30</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe3</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x1d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x82</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x66</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xca</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x60</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0xc0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x29</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x23</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xab</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x53</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6f</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xd5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xdb</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x37</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x45</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xde</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfd</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2f</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x03</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xff</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x72</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x51</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x8d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xaf</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x92</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbb</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xdd</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbc</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7f</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x11</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x41</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd8</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x0a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x31</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x88</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xcd</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbd</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x2d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x74</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x12</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xe5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb0</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x89</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x69</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x97</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x96</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x77</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7e</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x65</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x09</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x84</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x18</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xec</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xdc</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> 
  <span style='color:#008000;'>0x79</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xee</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xcb</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x39</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x48</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>

<span style='color:#696969;'>// Mixer-substitution T</span>
<span style='color:#696969;'>//</span>
<span style='color:#696969;'>// T is a substitution that generates 32 bits from 32 bits T : Z32</span>
<span style='color:#696969;'>// This substitution is a reversible process. </span>
<span style='color:#696969;'>// It consists of linear and non-linear substitution operations.  </span>

uint32_t T<span style='color:#808030;'>(</span>uint32_t x<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> t<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>int</span>   i<span style='color:#800080;'>;</span>
    w32_t u<span style='color:#800080;'>;</span>
    
    u<span style='color:#808030;'>.</span>w <span style='color:#808030;'>=</span> x<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// apply non-linear substitution</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      u<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> S<span style='color:#808030;'>[</span>u<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#696969;'>// apply linear substitution</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>t<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span>
    <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// for key setup</span>
      <span style='color:#800000;font-weight:bold;'>return</span> u<span style='color:#808030;'>.</span>w <span style='color:#808030;'>^</span> ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> 
                   ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> <span style='color:#008c00;'>23</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// for encryption</span>
      <span style='color:#800000;font-weight:bold;'>return</span> u<span style='color:#808030;'>.</span>w <span style='color:#808030;'>^</span> ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span>  <span style='color:#008c00;'>2</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> 
                   ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> <span style='color:#008c00;'>10</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> 
                   ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> <span style='color:#008c00;'>18</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> 
                   ROTL32<span style='color:#808030;'>(</span>u<span style='color:#808030;'>.</span>w<span style='color:#808030;'>,</span> <span style='color:#008c00;'>24</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>The assembly sticks close to the original in C.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>t_l0:</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x1
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x2
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x3
    <span style='color:#696969;'>; apply non-linear substitution</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span>
<span style='color:#e34adc;'>t_l1:</span>    
    <span style='color:#800000;font-weight:bold;'>xlatb</span>
    <span style='color:#800000;font-weight:bold;'>ror</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>t_l1</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; apply linear substitution</span>
    <span style='color:#800000;font-weight:bold;'>popfd</span>
    <span style='color:#800000;font-weight:bold;'>jc</span>     <span style='color:#e34adc;'>t_l2</span>
    <span style='color:#696969;'>; for key setup</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>13</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>23</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>t_l3</span>
<span style='color:#e34adc;'>t_l2:</span>    
    <span style='color:#696969;'>; for encryption</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>10</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>18</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>24</span>
    
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>
<span style='color:#e34adc;'>t_l3:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span>_eax<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
    
<span style='color:#696969;'>; in:  eax</span>
<span style='color:#696969;'>; out: eax  </span>
<span style='color:#e34adc;'>T_function:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>pushfd</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>t_l0</span>  <span style='color:#696969;'>; pushes address of sbox on stack</span>
    <span style='color:#696969;'>; sbox for SM4 goes here</span>
</pre>

<h3><strong>The round function F</strong></h3>

$latex F(X_0,X_1,X_2,X_3,rk)=X_0\oplus T(X_1\oplus X_2\oplus X_3\oplus rk)&amp;s=2$

<p>The value of 1 in last parameter to T function tells it to use the linear function for encryption. In x86 assembly, I use the <em>Carry Flag</em> (CF) setting or clearing with STC and CLC instructions.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// The round function F</span>
<span style='color:#696969;'>//</span>
<span style='color:#696969;'>// This algorithm uses a nonlinear substitution structure, </span>
<span style='color:#696969;'>// encrypting 32 bits at a time. This is called a one-round exchange.</span>

uint32_t F<span style='color:#808030;'>(</span>uint32_t x0<span style='color:#808030;'>,</span> uint32_t x1<span style='color:#808030;'>,</span> 
    uint32_t x2<span style='color:#808030;'>,</span> uint32_t x3<span style='color:#808030;'>,</span> uint32_t rk<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>return</span> x0 <span style='color:#808030;'>^</span> T<span style='color:#808030;'>(</span>x1 <span style='color:#808030;'>^</span> x2 <span style='color:#808030;'>^</span> x3 <span style='color:#808030;'>^</span> rk<span style='color:#808030;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

<h3><strong>The constant parameter CK</strong></h3>

$latex (ck_{i,0},ck_{i,1},ck_{i,2},ck_{i,3}) \in \Big(Z_2^8\Big)^4,\quad then\quad ck_{ij}=(4i+j)\times 7\: (mod \: 256)&amp;s=1$

<p>You can include the precomputed array, or generate at runtime using the algorithm.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// The constant parameter CK</span>
<span style='color:#696969;'>//</span>
<span style='color:#696969;'>// generate CK constant for index i</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>ifdef</span><span style='color:#004a43;'> TABLE</span>
uint32_t CK<span style='color:#808030;'>[</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>
<span style='color:#800080;'>{</span> <span style='color:#008000;'>0x00070e15</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1c232a31</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x383f464d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x545b6269</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x70777e85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8c939aa1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa8afb6bd</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xc4cbd2d9</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xe0e7eef5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xfc030a11</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x181f262d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x343b4249</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x50575e65</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6c737a81</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x888f969d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa4abb2b9</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xc0c7ced5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xdce3eaf1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf8ff060d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x141b2229</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x30373e45</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4c535a61</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x686f767d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x848b9299</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0xa0a7aeb5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xbcc3cad1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xd8dfe6ed</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xf4fb0209</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x10171e25</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2c333a41</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x484f565d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x646b7279</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>else</span>
uint32_t CK<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>int</span> i<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>int</span>      j<span style='color:#800080;'>;</span>
    uint32_t ck<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>

    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      ck <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span>
      ck <span style='color:#808030;'>|</span><span style='color:#808030;'>=</span> U8V<span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>i <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> j<span style='color:#808030;'>)</span> <span style='color:#808030;'>*</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#800000;font-weight:bold;'>return</span> ck<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>endif</span>
</pre>

<p>The assembly computes at runtime, since it requires less ROM.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; expects ecx to hold index</span>
<span style='color:#696969;'>; returns constant in eax</span>
<span style='color:#e34adc;'>CK:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>          <span style='color:#696969;'>; ck = 0</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>                      <span style='color:#696969;'>; j  = 0</span>
<span style='color:#e34adc;'>ck_l0:</span> 
    <span style='color:#800000;font-weight:bold;'>shl</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>            <span style='color:#696969;'>; ck &lt;&lt;= 8</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; ebx = (i*4) + j</span>
    <span style='color:#800000;font-weight:bold;'>imul</span>   <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>       <span style='color:#696969;'>; ebx *= 7</span>
    <span style='color:#800000;font-weight:bold;'>or</span>     <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>bl</span>            <span style='color:#696969;'>; ck |= ebx %= 256</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>               <span style='color:#696969;'>; j++</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span>            <span style='color:#696969;'>; j&lt;4</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>ck_l0</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span>_eax<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>   <span style='color:#696969;'>; return ck</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Key setup</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> sm4_setkey<span style='color:#808030;'>(</span>sm4_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>const</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    uint32_t t<span style='color:#808030;'>,</span> rk0<span style='color:#808030;'>,</span> rk1<span style='color:#808030;'>,</span> rk2<span style='color:#808030;'>,</span> rk3<span style='color:#800080;'>;</span> 
    <span style='color:#800000;font-weight:bold;'>int</span>      i<span style='color:#800080;'>;</span>    
    
    <span style='color:#696969;'>// load the key</span>
    rk0 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#808030;'>)</span><span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    rk1 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#808030;'>)</span><span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    rk2 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#808030;'>)</span><span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    rk3 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span><span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>key<span style='color:#808030;'>)</span><span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// xor FK values</span>
    rk0 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#008000;'>0xa3b1bac6</span><span style='color:#800080;'>;</span> rk1 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#008000;'>0x56aa3350</span><span style='color:#800080;'>;</span>
    rk2 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#008000;'>0x677d9197</span><span style='color:#800080;'>;</span> rk3 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#008000;'>0xb27022dc</span><span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// generate 32 sub keys</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>32</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>ifdef</span><span style='color:#004a43;'> TABLE</span>
        rk0 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> T<span style='color:#808030;'>(</span>rk1 <span style='color:#808030;'>^</span> rk2 <span style='color:#808030;'>^</span> rk3 <span style='color:#808030;'>^</span> CK<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>else</span><span style='color:#004a43;'>  </span>
        rk0 <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> T<span style='color:#808030;'>(</span>rk1 <span style='color:#808030;'>^</span> rk2 <span style='color:#808030;'>^</span> rk3 <span style='color:#808030;'>^</span> CK<span style='color:#808030;'>(</span>i<span style='color:#808030;'>)</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>endif</span>
      c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>rk<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> rk0<span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>rk0<span style='color:#808030;'>,</span> rk1<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>rk1<span style='color:#808030;'>,</span> rk2<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>rk2<span style='color:#808030;'>,</span> rk3<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#696969;'>// reverse the order of keys if decrypting</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> SM4_DECRYPT<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        XCHG<span style='color:#808030;'>(</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>rk<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>rk<span style='color:#808030;'>[</span><span style='color:#008c00;'>31</span> <span style='color:#808030;'>-</span> i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>Assembly code..</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>sm4_setkeyx:</span>
<span style='color:#e34adc;'>_sm4_setkeyx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; edi = ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span>  <span style='color:#696969;'>; esi = 128-bit key</span>
    <span style='color:#696969;'>; load the key</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> rk0
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> rk1
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> rk2
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> rk3
    
    <span style='color:#696969;'>; xor FK values</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    rk0<span style='color:#808030;'>,</span> <span style='color:#008000;'>0xa3b1bac6</span>    
    <span style='color:#800000;font-weight:bold;'>xor</span>    rk1<span style='color:#808030;'>,</span> <span style='color:#008000;'>0x56aa3350</span>    
    <span style='color:#800000;font-weight:bold;'>xor</span>    rk2<span style='color:#808030;'>,</span> <span style='color:#008000;'>0x677d9197</span>    
    <span style='color:#800000;font-weight:bold;'>xor</span>    rk3<span style='color:#808030;'>,</span> <span style='color:#008000;'>0xb27022dc</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
<span style='color:#e34adc;'>sk_l1:</span>    
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>CK</span>
    <span style='color:#800000;font-weight:bold;'>clc</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>T_function</span> 
    <span style='color:#800000;font-weight:bold;'>xor</span>    rk0<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> rk0
    <span style='color:#800000;font-weight:bold;'>stosd</span>                <span style='color:#696969;'>; rk[i] = rk0</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   rk0<span style='color:#808030;'>,</span> rk1
    <span style='color:#800000;font-weight:bold;'>xchg</span>   rk1<span style='color:#808030;'>,</span> rk2
    <span style='color:#800000;font-weight:bold;'>xchg</span>   rk2<span style='color:#808030;'>,</span> rk3
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ecx</span>           <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>sk_l1</span>       
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Encryption</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// swapping bytes *shouldn't* affect the cipher</span>

<span style='color:#800000;font-weight:bold;'>void</span> sm4_encrypt<span style='color:#808030;'>(</span>sm4_ctx <span style='color:#808030;'>*</span>c<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>buf<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint32_t x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> i<span style='color:#808030;'>,</span> t<span style='color:#800080;'>;</span>
    uint32_t <span style='color:#808030;'>*</span>rk<span style='color:#808030;'>=</span>c<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>rk<span style='color:#800080;'>;</span>
    uint32_t <span style='color:#808030;'>*</span>x<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>buf<span style='color:#800080;'>;</span>
    
    x0 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> x1 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    x2 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> x3 <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>32</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      x0 <span style='color:#808030;'>=</span> F<span style='color:#808030;'>(</span>x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>,</span> rk<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>x0<span style='color:#808030;'>,</span> x1<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>x1<span style='color:#808030;'>,</span> x2<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      XCHG<span style='color:#808030;'>(</span>x2<span style='color:#808030;'>,</span> x3<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>    
    x<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x3<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x2<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    x<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x1<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> SWAP32<span style='color:#808030;'>(</span>x0<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

<p>There's swapping of bytes between big-endian/little-endian numbering convention that wouldn't affect the security of cipher if removed.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>sm4_encryptx:</span>
<span style='color:#e34adc;'>_sm4_encryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; edi = ctx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; esi = buf</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>esi</span> <span style='color:#696969;'>; save buffer for later</span>
    
    <span style='color:#696969;'>; load data</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x0
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x1
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x2
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x3
    
    <span style='color:#696969;'>; do 32 rounds</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>32</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
<span style='color:#e34adc;'>e_l0:</span>
    <span style='color:#696969;'>; apply F round</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; rk[i]</span>
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#800000;font-weight:bold;'>stc</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>T_function</span>     
    <span style='color:#800000;font-weight:bold;'>xor</span>    x0<span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   x0<span style='color:#808030;'>,</span> x1
    <span style='color:#800000;font-weight:bold;'>xchg</span>   x1<span style='color:#808030;'>,</span> x2
    <span style='color:#800000;font-weight:bold;'>xchg</span>   x2<span style='color:#808030;'>,</span> x3
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>e_l0</span>
    
    <span style='color:#696969;'>; save data</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x3
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x2
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x1
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> x0
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>    
    <span style='color:#800000;font-weight:bold;'>stosd</span>    
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Summary</strong></h3>

<p>The source for this, including test unit can be <a href="https://github.com/odzhan/tinycrypt/tree/master/block/sm4">found here</a></p>
<p>Thanks to 0x4d_ for submitting $latex \LaTeX$ formulas.</p>
