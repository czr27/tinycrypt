<h3><strong>Introduction</strong></h3>

<p><a href="http://seed.kisa.or.kr/html/egovframework/iwt/ds/ko/ref/LEA%20A%20128-Bit%20Block%20Cipher%20for%20Fast%20Encryption%20on%20Common%20Processors-English.pdf">LEA</a> is a 128-bit block cipher with support for 128, 192 and 256-bit keys published in 2014. It was designed by Deukjo Hong, Jung-Keun Lee, Dong-Chan Kim, Daesung Kwon, Kwon Ho Ryu, and Dong-Geon Lee. The only operations used for encryption and the key schedule are 32-bit Addition, eXclusive OR and Rotation (ARX structure): the designers state <em>"the usage of 32-bit and 64-bit processors will grow rapidly compared to 8-bit and 16-bit ones"</em>. Today I'll just focus on an implementation using 128-bit keys referred to as LEA-128. This just about fits onto the 32-bit x86 architecture. The 256-bit version requires additional registers and is probably better suited for 64-bit mode.</p>

<h3><strong>Key Schedule</strong></h3>

<p>During generation of subkeys, a number of predefined constants are used.</p>

$latex \textbf{Constants. } $
$latex \text{The key schedule uses several constants for generating round keys, which are defined as}$

<p align="center">
$latex \delta[0] = 0xc3efe9db, \quad \delta[1] = 0x44626b02, $
$latex \delta[2] = 0x79e27c8a, \quad \delta[3] = 0x78df30ec, $
$latex \delta[4] = 0x715ea49e, \quad \delta[5] = 0xc785da0a, $
$latex \delta[6] = 0xe04ef22a, \quad \delta[7] = 0xe5c40957. $</p>

<p align="center">
$latex \text{They are obtained from hexadecimal expression of } \sqrt{766965}, $
$latex \text{ where 76, 69 and 65 are ASCII codes of 'L', 'E' and 'A'.}$</p>

<p>You can obtain the values using a tool like speedcrunch.</p>

<img src="https://tinycrypt.files.wordpress.com/2017/03/lea_speed.png" alt="" width="640" height="125" class="aligncenter size-full wp-image-2349" />
 
<p>There are 3 different key schedule functions but I only focus on the 128-bit variant for now.</p>

$latex \textbf{Key Schedule with a 128-Bit Key. } $
$latex \text{Let } K = (K[0], K[1], K[2], K[3]) \text{ be a 128-bit key. We set } T[i] = K[i]\: for \: 0\leq 4. 
\text{ Round key} RK_i = (RK_i[0], RK_i[1],\dots , RK_i[5])\: for\: 0\leq i &lt; 24 \text{ are produced through the following relations:}$

<p align="center">
$latex
T[0]\leftarrow ROL_1(T[0]\oplus ROL_i(\delta[i\:mod\: 4])),\\
T[1]\leftarrow ROL_3(T[1]\oplus ROL_{i+1}(\delta[i\:mod\: 4])),\\
T[2]\leftarrow ROL_6(T[2]\oplus ROL_{i+2}(\delta[i\:mod\: 4])),\\
T[3]\leftarrow ROL_{11}(T[3]\oplus ROL_{i+3}(\delta[i\:mod\: 4])),\\
RK_i\leftarrow (T[0], T[1], T[2], T[3], T[1]).
$
</p>

<h3><strong>Compact code</strong></h3>

<p>The following function combines encryption and key scheduling. It will encrypt 128-bits of <var>data</var> using a 128-bit master key <var>mk</var>. I'd suggest using this with counter (CTR) mode.</p>
 
<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> R</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>32</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> W<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>void</span> lea128<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>mk<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>p<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    W r<span style='color:#808030; '>,</span>t<span style='color:#808030; '>,</span><span style='color:#808030; '>*</span>x<span style='color:#808030; '>=</span>p<span style='color:#808030; '>,</span><span style='color:#808030; '>*</span>k<span style='color:#808030; '>=</span>mk<span style='color:#800080; '>;</span>
    W c<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>
      <span style='color:#800080; '>{</span><span style='color:#008000; '>0xc3efe9db</span><span style='color:#808030; '>,</span><span style='color:#008000; '>0x88c4d604</span><span style='color:#808030; '>,</span>
       <span style='color:#008000; '>0xe789f229</span><span style='color:#808030; '>,</span><span style='color:#008000; '>0xc6f98763</span><span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>

    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>r<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>r<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>24</span><span style='color:#800080; '>;</span>r<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
      t<span style='color:#808030; '>=</span>c<span style='color:#808030; '>[</span>r<span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
      c<span style='color:#808030; '>[</span>r<span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>28</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#808030; '>*</span>k<span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>k<span style='color:#808030; '>+</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>29</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>26</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>29</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>21</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>      
      t<span style='color:#808030; '>=</span><span style='color:#808030; '>*</span>x<span style='color:#800080; '>;</span>
      <span style='color:#808030; '>*</span>x<span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span>x<span style='color:#808030; '>^</span><span style='color:#808030; '>*</span>k<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>23</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      x<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      x<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      x<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>t<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>x86 assembly</strong></h3>

<p>You might notice the constants are different from C source. For whatever reason, the last 3 are rotated a number of bits left before entering the encryption loop. Obviously a compiler will be smart enough to see this and automatically optimize, but for assembly code, we must rotate them manually. They're stored on the stack using PUSHAD. EDI, ESI, EBP and ESP are used for TD array. ESP has to be initialized after the PUSHAD for obvious reasons. We don't want to cause an exception.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>; -----------------------------------------------</span>
<span style='color:#696969; '>; LEA-128/128 Block Cipher in x86 assembly (Encryption only)</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; size: 136 bytes</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; global calls use cdecl convention</span>
<span style='color:#696969; '>;</span>
<span style='color:#696969; '>; -----------------------------------------------</span>

<span style='color:#004a43; '>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43; '>%ifndef</span><span style='color:#004a43; '> BIN</span>
      <span style='color:#004a43; '>global</span> lea1<span style='color:#008c00; '>28</span>
      <span style='color:#004a43; '>global</span> _lea1<span style='color:#008c00; '>28</span>
<span style='color:#004a43; '>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43; '>%endif</span>

    <span style='color:#004a43; '>bits</span> <span style='color:#008c00; '>32</span>

<span style='color:#004a43; '>struc</span> pushad_t
  _edi <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _esi <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _ebp <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _esp <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _ebx <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _edx <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _ecx <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
  _eax <span style='color:#800000; font-weight:bold; '>resd</span> <span style='color:#008c00; '>1</span>
<span style='color:#e34adc; '>&#xa0;&#xa0;.size:</span>
<span style='color:#004a43; '>endstruc</span>

<span style='color:#696969; '>; plain text</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w0 dword[esi+4*0]</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w1 dword[esi+4*1]</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w2 dword[esi+4*2]</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w3 dword[esi+4*3]</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w4 ecx</span>

<span style='color:#696969; '>; key</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w5 ebx</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w6 edx</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w7 edi</span>
<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> w8 ebp</span>

<span style='color:#004a43; '>%define</span><span style='color:#004a43; '> LEA128_RNDS 24</span>

<span style='color:#e34adc; '>lea128:</span>
<span style='color:#e34adc; '>_lea128:</span>
    <span style='color:#800000; font-weight:bold; '>pushad</span>
    <span style='color:#696969; '>; initialize 4 constants</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>edi</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xc3efe9db</span>   <span style='color:#696969; '>; c0</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x88c4d604</span>   <span style='color:#696969; '>; c1</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>ebp</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xe789f229</span>   <span style='color:#696969; '>; c2</span>
    <span style='color:#800000; font-weight:bold; '>pushad</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span>_esp<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xc6f98763</span>   <span style='color:#696969; '>; c3</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>64</span><span style='color:#008c00; '>+4</span><span style='color:#808030; '>]</span>   <span style='color:#696969; '>; esi = key</span>
    <span style='color:#696969; '>; load key</span>
    <span style='color:#800000; font-weight:bold; '>lodsd</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> w5
    <span style='color:#800000; font-weight:bold; '>lodsd</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> w6
    <span style='color:#800000; font-weight:bold; '>lodsd</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> w7
    <span style='color:#800000; font-weight:bold; '>lodsd</span>
    <span style='color:#800000; font-weight:bold; '>xchg</span>   <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> w8
    <span style='color:#800000; font-weight:bold; '>mov</span>    <span style='color:#000080; '>esi</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>64</span><span style='color:#008c00; '>+8</span><span style='color:#808030; '>]</span>   <span style='color:#696969; '>; esi = data</span>
    <span style='color:#800000; font-weight:bold; '>xor</span>    <span style='color:#000080; '>eax</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>eax</span>          <span style='color:#696969; '>; i = 0</span>
<span style='color:#e34adc; '>lea_l0:</span>
    <span style='color:#800000; font-weight:bold; '>push</span>   <span style='color:#000080; '>eax</span>
    <span style='color:#696969; '>; t = c[r%4]; </span>
    <span style='color:#800000; font-weight:bold; '>and</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w4<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#008c00; '>+4</span><span style='color:#808030; '>]</span>
    <span style='color:#696969; '>; c[r%4] = R(t, 28);</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    <span style='color:#800000; font-weight:bold; '>dword</span><span style='color:#808030; '>[</span><span style='color:#000080; '>esp</span><span style='color:#808030; '>+</span><span style='color:#000080; '>eax</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span><span style='color:#008c00; '>+4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>28</span>
    <span style='color:#696969; '>; **************************************</span>
    <span style='color:#696969; '>; create sub key</span>
    <span style='color:#696969; '>; **************************************</span>
    <span style='color:#696969; '>; k[0] = R(k[0] + t, 31);</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w5<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>rol</span>    w5<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#696969; '>; k[1] = R(k[1] + R(t, 31), 29);</span>
    <span style='color:#800000; font-weight:bold; '>rol</span>    w4<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w6<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w6<span style='color:#808030; '>,</span> <span style='color:#008c00; '>29</span>
    <span style='color:#696969; '>; k[2] = R(k[2] + R(t, 30), 26);</span>
    <span style='color:#800000; font-weight:bold; '>rol</span>    w4<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w7<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w7<span style='color:#808030; '>,</span> <span style='color:#008c00; '>26</span>
    <span style='color:#696969; '>; k[3] = R(k[3] + R(t, 29), 21); </span>
    <span style='color:#800000; font-weight:bold; '>rol</span>    w4<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w8<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w8<span style='color:#808030; '>,</span> <span style='color:#008c00; '>21</span>
    <span style='color:#696969; '>; **************************************</span>
    <span style='color:#696969; '>; encrypt block</span>
    <span style='color:#696969; '>; **************************************</span>
    <span style='color:#696969; '>; t = x[0];</span>
    <span style='color:#800000; font-weight:bold; '>push</span>   w0
    <span style='color:#696969; '>; x[0] = R((x[0] ^ k[0]) + (x[1] ^ k[1]), 23);</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w4<span style='color:#808030; '>,</span> w1
    <span style='color:#800000; font-weight:bold; '>xor</span>    w4<span style='color:#808030; '>,</span> w6
    <span style='color:#800000; font-weight:bold; '>xor</span>    w0<span style='color:#808030; '>,</span> w5
    <span style='color:#800000; font-weight:bold; '>add</span>    w0<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w0<span style='color:#808030; '>,</span> <span style='color:#008c00; '>23</span>
    <span style='color:#696969; '>; x[1] = R((x[1] ^ k[2]) + (x[2] ^ k[1]), 5);</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w4<span style='color:#808030; '>,</span> w2
    <span style='color:#800000; font-weight:bold; '>xor</span>    w4<span style='color:#808030; '>,</span> w6
    <span style='color:#800000; font-weight:bold; '>xor</span>    w1<span style='color:#808030; '>,</span> w7
    <span style='color:#800000; font-weight:bold; '>add</span>    w1<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w1<span style='color:#808030; '>,</span> <span style='color:#008c00; '>5</span>
    <span style='color:#696969; '>; x[2] = R((x[2] ^ k[3]) + (x[3] ^ k[1]), 3);</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w4<span style='color:#808030; '>,</span> w3
    <span style='color:#800000; font-weight:bold; '>xor</span>    w4<span style='color:#808030; '>,</span> w6
    <span style='color:#800000; font-weight:bold; '>xor</span>    w2<span style='color:#808030; '>,</span> w8
    <span style='color:#800000; font-weight:bold; '>add</span>    w2<span style='color:#808030; '>,</span> w4
    <span style='color:#800000; font-weight:bold; '>ror</span>    w2<span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>
    <span style='color:#696969; '>; x[3] = t;</span>
    <span style='color:#800000; font-weight:bold; '>pop</span>    w3
    <span style='color:#800000; font-weight:bold; '>pop</span>    <span style='color:#000080; '>eax</span>
    <span style='color:#696969; '>; i++;</span>
    <span style='color:#800000; font-weight:bold; '>inc</span>    <span style='color:#000080; '>eax</span>
    <span style='color:#696969; '>; i&lt;LEA128_RNDS</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    <span style='color:#000080; '>al</span><span style='color:#808030; '>,</span> LEA128_RNDS
    <span style='color:#800000; font-weight:bold; '>jnz</span>    <span style='color:#e34adc; '>lea_l0</span>

    <span style='color:#800000; font-weight:bold; '>popad</span>
    <span style='color:#800000; font-weight:bold; '>popad</span>
    <span style='color:#800000; font-weight:bold; '>ret</span>
</pre>

<h3><strong>ARM64 assembly</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> <span style='color:#800000; font-weight:bold; '>LEA</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>128</span><span style='color:#808030; '>/</span><span style='color:#008c00; '>128</span> <span style='color:#800000; font-weight:bold; '>in</span> ARM6<span style='color:#008c00; '>4</span> assembly
<span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> <span style='color:#008c00; '>224</span> bytes

    .arch armv8<span style='color:#808030; '>-</span>a

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> <span style='color:#004a43; '>include</span> the MOVL <span style='color:#004a43; '>macro</span>
    .<span style='color:#004a43; '>include</span> <span style='color:#0000e6; '>"../../include.inc"</span>

    .text
    .<span style='color:#004a43; '>global</span> lea1<span style='color:#008c00; '>28</span>

<span style='color:#e34adc; '>lea128:</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    x1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> x0
    <span style='color:#800000; font-weight:bold; '>mov</span>    x1<span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span> x1

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> allocate <span style='color:#008c00; '>16</span> bytes
    <span style='color:#800000; font-weight:bold; '>sub</span>    <span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> load immediate values
    movl   w0<span style='color:#808030; '>,</span> <span style='color:#008000; '>0xc3efe9db</span>
    movl   w1<span style='color:#808030; '>,</span> <span style='color:#008000; '>0x88c4d604</span>
    movl   w2<span style='color:#808030; '>,</span> <span style='color:#008000; '>0xe789f229</span>
    movl   w3<span style='color:#808030; '>,</span> <span style='color:#008000; '>0xc6f98763</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> store on <span style='color:#004a43; '>stack</span>
    <span style='color:#800000; font-weight:bold; '>str</span>    w0<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span>    <span style='color:#808030; '>]</span>
    <span style='color:#800000; font-weight:bold; '>str</span>    w1<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span>  <span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span>
    <span style='color:#800000; font-weight:bold; '>str</span>    w2<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span>  <span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span>
    <span style='color:#800000; font-weight:bold; '>str</span>    w3<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>12</span><span style='color:#808030; '>]</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> <span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span>r<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#696969; '>;r&lt;24;r++) {</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w8<span style='color:#808030; '>,</span> wzr

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> load <span style='color:#008c00; '>128</span><span style='color:#808030; '>-</span>bit key
    ldp    w4<span style='color:#808030; '>,</span> w5<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span>
    ldp    w6<span style='color:#808030; '>,</span> w7<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> load <span style='color:#008c00; '>128</span><span style='color:#808030; '>-</span>bit plaintext
    ldp    w0<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span>
    ldp    w2<span style='color:#808030; '>,</span> w3<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span>
<span style='color:#e34adc; '>L0:</span>
    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> t<span style='color:#808030; '>=</span><span style='color:#004a43; '>c</span><span style='color:#808030; '>[</span>r<span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>and</span>    w9<span style='color:#808030; '>,</span> w8<span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span> 
    ldr    w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> x9<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>lsl</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span>
	
    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> <span style='color:#004a43; '>c</span><span style='color:#808030; '>[</span>r<span style='color:#808030; '>%</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>28</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>ror</span> <span style='color:#008c00; '>28</span>
    <span style='color:#800000; font-weight:bold; '>str</span>    w1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span><span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> x9<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>lsl</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> k<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w4<span style='color:#808030; '>,</span> w4<span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w4<span style='color:#808030; '>,</span> w4<span style='color:#808030; '>,</span> <span style='color:#008c00; '>31</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>31</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>29</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>31</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w5<span style='color:#808030; '>,</span> w5<span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w5<span style='color:#808030; '>,</span> w5<span style='color:#808030; '>,</span> <span style='color:#008c00; '>29</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>26</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>30</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w6<span style='color:#808030; '>,</span> w6<span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w6<span style='color:#808030; '>,</span> w6<span style='color:#808030; '>,</span> <span style='color:#008c00; '>26</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span><span style='color:#008c00; '>29</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>21</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w1<span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>29</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w7<span style='color:#808030; '>,</span> w7<span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>1</span>
    <span style='color:#800000; font-weight:bold; '>ror</span>    w7<span style='color:#808030; '>,</span> w7<span style='color:#808030; '>,</span> <span style='color:#008c00; '>21</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> t<span style='color:#808030; '>=</span>x<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w1<span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> w0

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> w<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>23</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    eor    w0<span style='color:#808030; '>,</span> w0<span style='color:#808030; '>,</span> w4
    eor    w9<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> w5
    <span style='color:#800000; font-weight:bold; '>add</span>    w0<span style='color:#808030; '>,</span> w0<span style='color:#808030; '>,</span> w9
    <span style='color:#800000; font-weight:bold; '>ror</span>    w0<span style='color:#808030; '>,</span> w0<span style='color:#808030; '>,</span> <span style='color:#008c00; '>23</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> w<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    eor    w1<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> w6
    eor    w9<span style='color:#808030; '>,</span> w2<span style='color:#808030; '>,</span> w5
    <span style='color:#800000; font-weight:bold; '>add</span>    w1<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> w9
    <span style='color:#800000; font-weight:bold; '>ror</span>    w1<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> <span style='color:#008c00; '>5</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> w<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    eor    w2<span style='color:#808030; '>,</span> w2<span style='color:#808030; '>,</span> w7
    eor    w3<span style='color:#808030; '>,</span> w3<span style='color:#808030; '>,</span> w5
    <span style='color:#800000; font-weight:bold; '>add</span>    w2<span style='color:#808030; '>,</span> w2<span style='color:#808030; '>,</span> w3
    <span style='color:#800000; font-weight:bold; '>ror</span>    w2<span style='color:#808030; '>,</span> w2<span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> w<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>t<span style='color:#696969; '>;</span>
    <span style='color:#800000; font-weight:bold; '>mov</span>    w3<span style='color:#808030; '>,</span> w1<span style='color:#008c00; '>0</span>

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> r<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>
    <span style='color:#800000; font-weight:bold; '>add</span>    w8<span style='color:#808030; '>,</span> w8<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span>
    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> r <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>24</span>
    <span style='color:#800000; font-weight:bold; '>cmp</span>    w8<span style='color:#808030; '>,</span> <span style='color:#008c00; '>24</span>
    bne    L0

    <span style='color:#808030; '>/</span><span style='color:#808030; '>/</span> save <span style='color:#008c00; '>128</span><span style='color:#808030; '>-</span>bit ciphertext
    stp    w0<span style='color:#808030; '>,</span> w1<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span>
    stp    w2<span style='color:#808030; '>,</span> w3<span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span>x1<span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>8</span><span style='color:#808030; '>]</span>

    <span style='color:#800000; font-weight:bold; '>add</span>    <span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> <span style='color:#000080; '>sp</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>4</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4</span>
    <span style='color:#800000; font-weight:bold; '>ret</span>
</pre>

<p><a href="https://github.com/odzhan/tinycrypt/tree/master/block/lea">Sources here.</a></p>

<p>Thanks to 0x4d_ for submitting $latex \LaTeX$ formulas.</p>

