<h3><strong>Introduction</strong></h3>

<p>Kuznyechik ("Grasshopper" in Russian) is a 128-bit block cipher with support for 256-bit keys. It's defined in the National Standard of the Russian Federation <a href="http://tc26.ru/en/standard/gost/GOST_R_34_12_2015_ENG.pdf">GOST R 34.12-2015</a> and <a href="https://tools.ietf.org/rfc/rfc7801.txt">RFC 7801</a>. It was published in 2015 to supercede GOST 28147-89 also referred to as <a href="https://tools.ietf.org/rfc/rfc5830.txt">Magma</a> that was declassified in 1994. Kuznyechik uses a Substitution-permutation Network (SPN) construction.</p>

<h3><strong>Compact code</strong></h3>

<p>The following code combines encryption and key scheduling in one function. <var>mk</var> should point to a 256-bit master key while <var>data</var> should point to a 128-bit block of plaintext to encrypt. The function to generate sbox values on the fly is enabled by default. Define LUT to use a lookup table instead.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> F</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>j</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>0</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>j</span><span style='color:#808030; '>&lt;</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>j</span><span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> B<span style='color:#800080; '>;</span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>ifdef</span><span style='color:#004a43; '> LUT</span>
B S<span style='color:#808030; '>[</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span>
    <span style='color:#008000; '>0xFC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x11</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x31</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x16</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xFB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x23</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x04</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4D</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x77</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x93</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x99</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBA</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x17</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x36</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x14</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC1</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x18</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x65</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x21</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x81</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x42</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x01</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x05</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x84</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x02</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA0</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x06</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xED</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x98</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xEB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x34</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x51</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x48</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAB</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x68</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCC</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xB5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x70</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x56</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x08</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x76</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x12</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xBF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x72</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x13</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x47</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x87</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x15</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x96</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x29</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x10</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC7</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x91</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x78</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB1</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x32</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x75</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x19</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x35</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7E</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x6D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x54</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x80</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x57</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xDF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x24</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x43</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC9</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xD7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x79</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x22</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x03</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x94</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBC</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xDC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x28</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x50</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x33</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4A</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xA7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x97</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x60</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x73</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x00</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x62</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x44</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x1A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x38</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x82</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x64</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x26</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x41</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xAD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x45</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x46</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x92</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x27</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x55</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x8C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x69</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x95</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3B</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x07</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x58</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x40</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x86</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF7</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x30</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x37</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x88</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x89</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x83</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x49</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFE</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x8D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x53</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x90</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x85</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x61</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x20</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x71</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x67</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x09</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5B</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xCB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x25</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x52</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x59</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x74</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC0</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xD1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x66</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x39</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x63</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB6</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
    
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> SBOX</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>)</span><span style='color:#004a43; '> S</span><span style='color:#808030; '>[</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>]</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>else</span>

B S<span style='color:#808030; '>(</span>B x<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    B y<span style='color:#808030; '>,</span>z<span style='color:#800080; '>;</span>
    B s<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>
      <span style='color:#800080; '>{</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>221</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>146</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>79</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>147</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>153</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>11</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>68</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>214</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>78</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>220</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>152</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>69</span><span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>

    B k<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>
      <span style='color:#800080; '>{</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>50</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>6</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>22</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>34</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>48</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>54</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>36</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>52</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>38</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>

    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>=</span>z<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>z<span style='color:#808030; '>!</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>z<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        y<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#008000; '>0x1d</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>=</span><span style='color:#808030; '>=</span>x<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>break</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      x<span style='color:#808030; '>=</span>z<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    z<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>/</span><span style='color:#008c00; '>17</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    x<span style='color:#808030; '>%</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>17</span><span style='color:#800080; '>;</span>
    x <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> <span style='color:#800080; '>?</span> k<span style='color:#808030; '>[</span>x<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>s<span style='color:#808030; '>[</span>z<span style='color:#808030; '>]</span> <span style='color:#800080; '>:</span> k<span style='color:#808030; '>[</span>z<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
    
    <span style='color:#800000; font-weight:bold; '>return</span> x<span style='color:#808030; '>^</span><span style='color:#008c00; '>252</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> SBOX</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>)</span><span style='color:#004a43; '> S</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>x</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>endif</span>

<span style='color:#800000; font-weight:bold; '>void</span> kuz_lt<span style='color:#808030; '>(</span>B <span style='color:#808030; '>*</span>p<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    B i<span style='color:#808030; '>,</span>j<span style='color:#808030; '>,</span>t<span style='color:#808030; '>,</span>x<span style='color:#808030; '>,</span>y<span style='color:#808030; '>,</span>z<span style='color:#800080; '>;</span>
    B m<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span>
      <span style='color:#008000; '>0x94</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x20</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x85</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x10</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x01</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFB</span><span style='color:#808030; '>,</span>
      <span style='color:#008000; '>0x01</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x10</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x85</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x20</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x94</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x01</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>

    F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      t<span style='color:#808030; '>=</span>p<span style='color:#808030; '>[</span><span style='color:#008c00; '>15</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
      <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>=</span><span style='color:#008c00; '>14</span><span style='color:#800080; '>;</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>char</span><span style='color:#808030; '>)</span>i<span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>i<span style='color:#808030; '>-</span><span style='color:#808030; '>-</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>=</span>p<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>y<span style='color:#808030; '>=</span>m<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>z<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>p<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>x<span style='color:#800080; '>;</span>y<span style='color:#800080; '>;</span>y<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
          <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>&amp;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>z<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>x<span style='color:#800080; '>;</span>
          x<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#008000; '>0xc3</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        t<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>z<span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
      p<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>t<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>void</span> kuznyechik<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>mk<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>data<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    B c<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>k<span style='color:#808030; '>[</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>r<span style='color:#808030; '>,</span>i<span style='color:#808030; '>,</span>j<span style='color:#808030; '>,</span>t<span style='color:#808030; '>,</span><span style='color:#808030; '>*</span>x<span style='color:#808030; '>=</span>data<span style='color:#800080; '>;</span>

    <span style='color:#696969; '>// copy master key to local buffer</span>
    F<span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>B<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>mk<span style='color:#808030; '>)</span><span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>

    <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>r<span style='color:#808030; '>=</span>i<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span><span style='color:#800080; '>;</span>i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      <span style='color:#696969; '>// perform encryption every 8 rounds</span>
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>!</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>&amp;</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        <span style='color:#800000; font-weight:bold; '>for</span><span style='color:#808030; '>(</span>t<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>t<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>32</span><span style='color:#800080; '>;</span>t<span style='color:#808030; '>+</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
          <span style='color:#696969; '>// add key</span>
          F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span>x<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>+</span>t<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
          <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>r<span style='color:#808030; '>=</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
          <span style='color:#696969; '>// non-linear layer</span>
          F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span>x<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>SBOX<span style='color:#808030; '>(</span>x<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
          <span style='color:#696969; '>// linear layer</span>
          kuz_lt<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
      <span style='color:#800080; '>}</span>
      <span style='color:#696969; '>// generate round constant</span>
      F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span>c<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>c<span style='color:#808030; '>[</span><span style='color:#008c00; '>15</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#696969; '>// apply linear layer</span>
      kuz_lt<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#696969; '>// mix 128-bits of key and apply non-linear layer</span>
      F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span>c<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>SBOX<span style='color:#808030; '>(</span>c<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#696969; '>// apply linear layer</span>
      kuz_lt<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
      <span style='color:#696969; '>// mix last 128-bits of key and prepare next</span>
      F<span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span>t<span style='color:#808030; '>=</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>c<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>+</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>k<span style='color:#808030; '>[</span>j<span style='color:#808030; '>+</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>t<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>About the C code</strong></h3>

<p>The <a href="https://github.com/mjosaarinen/kuznechik">original code</a> I used is based on an implementation written by <a href="https://mjos.fi/">Dr. Markku-Juhani O. Saarinen</a>. While I have derived my own implementation from code originally written by Markku, he has not endorsed the changes I've made.</p>

<h3><strong>Sbox initialization</strong></h3>

<p>The designers of Kuznyechik asserted the sbox values were chosen "randomly". <a href="http://wwwfr.uni.lu/recherche/fstc/computer_science_and_communications_research_unit/membres/alex_biryukov">Alex Biryukov</a>, <a href="http://wwwen.uni.lu/snt/people/leo_paul_perrin">Leo Perrin</a>, and <a href="http://wwwen.uni.lu/snt/people/aleksei_udovenko">Aleksei Udovenko</a> show in their paper <a href="https://eprint.iacr.org/2016/071">Reverse-Engineering the S-Box of Streebog, Kuznyechik and STRIBOBr1</a> that the S-Boxes of both Kuznyechik and Streebog were not created pseudo-randomly, but was generated using a hidden algorithm that they were partially able to reverse engineer. In 2019, Leo Perrin published further research in a paper called <a href="https://eprint.iacr.org/2019/092">Partitions in the S-Box of Streebog and Kuznyechik</a> and has <a href="https://mailarchive.ietf.org/arch/msg/cfrg/4PmssKzCBsxTmLCieDgqD7Nynwg">implied</a> there may be a weakness in Kuznyechik that only the designers know about.</p>

<pre style='color:#000000;background:#ffffff;'>#define F<span style='color:#808030; '>(</span>n<span style='color:#808030; '>)</span><span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span>j<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#696969; '>;j&lt;n;j++)</span>
<span style='color:#004a43; '>typedef</span> unsigned char B<span style='color:#696969; '>;</span>

#<span style='color:#004a43; '>ifdef</span> LUT
B S<span style='color:#808030; '>[</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>{</span>
    <span style='color:#008000; '>0xFC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x11</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x31</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x16</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xFB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x23</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x04</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4D</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x77</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x93</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x99</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBA</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x17</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x36</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x14</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC1</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x18</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x65</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x21</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x81</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x42</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x01</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x05</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x84</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x02</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA0</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x06</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xED</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x98</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xEB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x34</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x51</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x48</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAB</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x68</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCC</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xB5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x70</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x56</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x08</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x76</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x12</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xBF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x72</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x13</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x47</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x87</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x15</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x96</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x29</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x10</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC7</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xF3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x91</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x78</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB1</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x32</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x75</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x19</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x35</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x8A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7E</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x6D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x54</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x80</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x57</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xDF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x24</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x43</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC9</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xD7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x79</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x22</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x03</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xEC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xDE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x94</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBC</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xDC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x28</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x50</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x33</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x0A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4A</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xA7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x97</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x60</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x73</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x00</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x62</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x44</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x1A</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x38</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x82</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x64</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x26</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x41</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xAD</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x45</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x46</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x92</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x27</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5E</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x55</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2F</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x8C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x7D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x69</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x95</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3B</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x07</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x58</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB3</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x40</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x86</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAC</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF7</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x30</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x37</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x88</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD9</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE7</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x89</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xE1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x1B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x83</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x49</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x3F</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xFE</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x8D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x53</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x90</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xCA</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD8</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x85</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x61</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x20</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x71</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x67</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2D</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x2B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x09</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x5B</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xCB</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x9B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x25</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD0</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xBE</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE5</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x6C</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x52</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0x59</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xA6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x74</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xD2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xE6</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xF4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB4</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC0</span><span style='color:#808030; '>,</span>
    <span style='color:#008000; '>0xD1</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x66</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xAF</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xC2</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x39</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x4B</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0x63</span><span style='color:#808030; '>,</span> <span style='color:#008000; '>0xB6</span> <span style='color:#808030; '>}</span><span style='color:#696969; '>;</span>
    
#define SBOX<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> S<span style='color:#808030; '>[</span>x<span style='color:#808030; '>]</span>
#<span style='color:#004a43; '>else</span>

B S<span style='color:#808030; '>(</span>B x<span style='color:#808030; '>)</span> <span style='color:#808030; '>{</span>
    B y<span style='color:#808030; '>,</span>z<span style='color:#696969; '>;</span>
    B s<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>
      <span style='color:#808030; '>{</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>221</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>146</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>79</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>147</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>153</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>11</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>68</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>214</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>215</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>78</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>220</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>152</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>69</span><span style='color:#808030; '>}</span><span style='color:#696969; '>;</span>

    B k<span style='color:#808030; '>[</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>
      <span style='color:#808030; '>{</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>50</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>6</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>22</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>34</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>48</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>54</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>36</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>52</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>38</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>}</span><span style='color:#696969; '>;</span>

    <span style='color:#004a43; '>if</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> <span style='color:#808030; '>{</span>
      <span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>=</span>z<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#696969; '>;z!=0;z++) {</span>
        y<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>&amp;<span style='color:#008000; '>0x1d</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
        <span style='color:#004a43; '>if</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>=</span><span style='color:#808030; '>=</span>x<span style='color:#808030; '>)</span>break<span style='color:#696969; '>;</span>
      <span style='color:#808030; '>}</span>
      x<span style='color:#808030; '>=</span>z<span style='color:#696969; '>;</span>
    <span style='color:#808030; '>}</span>
    z<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>/</span><span style='color:#008c00; '>17</span><span style='color:#808030; '>)</span><span style='color:#696969; '>;</span>
    x<span style='color:#808030; '>%</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>17</span><span style='color:#696969; '>;</span>
    x <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> k<span style='color:#808030; '>[</span>x<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>s<span style='color:#808030; '>[</span>z<span style='color:#808030; '>]</span> <span style='color:#808030; '>:</span> k<span style='color:#808030; '>[</span>z<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#696969; '>;</span>
    
    return x<span style='color:#808030; '>^</span><span style='color:#008c00; '>252</span><span style='color:#696969; '>;</span>
<span style='color:#808030; '>}</span>
#define SBOX<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span> S<span style='color:#808030; '>(</span>x<span style='color:#808030; '>)</span>
#<span style='color:#004a43; '>endif</span>
</pre>

<p>Creating the inverse sbox tables with code is smaller than including it as array.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; initialize sbox tables </span>
<span style='color:#696969;'>; edi = key context</span>
<span style='color:#e34adc;'>load_sbox:</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ebx</span>               <span style='color:#696969;'>; ebx = kuz_pi</span>
<span style='color:#e34adc;'>sbox_loop:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>dl</span>            <span style='color:#696969;'>; al = i</span>
    <span style='color:#800000;font-weight:bold;'>xlatb</span>                    <span style='color:#696969;'>; al = kuz_pi[i]</span>
    <span style='color:#800000;font-weight:bold;'>stosb</span>                    <span style='color:#696969;'>; key-&gt;pi[i] = al</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>dl</span>     <span style='color:#696969;'>; key-&gt;pi_inv[kuz_pi[i]] = i</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>dl</span>                <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>sbox_loop</span>         <span style='color:#696969;'>; i&lt;256</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>

<span style='color:#e34adc;'>kuz_init:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>dh</span>                <span style='color:#696969;'>; edx=256</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>          <span style='color:#696969;'>; edi = key-&gt;pi</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span>    <span style='color:#696969;'>; esi = key-&gt;pi_inv</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>load_sbox</span>
<span style='color:#696969;'>; The S-Box from section 5.1.1</span>
<span style='color:#e34adc;'>kuz_pi:</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xFC</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xEE</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xDD</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x11</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x31</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x16</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 00..07</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xFB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFA</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xDA</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x23</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x04</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4D</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 08..0F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xE9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x77</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xDB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x93</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x99</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBA</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 10..17</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x17</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x36</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x14</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCD</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC1</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 18..1F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xF9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x18</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x65</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xEF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x21</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 20..27</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x81</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x42</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4F</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 28..2F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x05</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x84</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x02</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xAE</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA0</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 30..37</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x06</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xED</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x98</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1F</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 38..3F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xEB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x34</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x51</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xEA</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x48</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xAB</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 40..47</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xF2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x68</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFD</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCE</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCC</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 48..4F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xB5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x70</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x56</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x08</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x76</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x12</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 50..57</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xBF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x72</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x13</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x47</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x87</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 58..5F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x15</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x96</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x29</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC7</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 60..67</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xF3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x91</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x78</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB1</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 68..6F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x32</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x75</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x19</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x35</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x8A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7E</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 70..77</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x6D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x54</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x80</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBD</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x57</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 78..7F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xDF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x24</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x43</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC9</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 80..87</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xD7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x79</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x22</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x03</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 88..8F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xE0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xEC</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xDE</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBC</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 90..97</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xDC</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x28</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x50</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x33</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4A</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; 98..9F</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xA7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x97</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x60</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x73</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x00</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x62</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x44</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; A0..A7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x1A</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x38</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x82</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x64</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x26</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x41</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; A8..AF</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xAD</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x45</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x46</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x92</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x27</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5E</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x55</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2F</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; B0..B7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x8C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x69</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x95</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3B</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; B8..BF</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x07</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x58</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB3</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x40</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x86</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xAC</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF7</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; C0..C7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x30</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x37</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x88</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD9</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE7</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x89</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; C8..CF</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xE1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x83</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x49</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3F</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFE</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; D0..D7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x8D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x53</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xAA</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x90</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xCA</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD8</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x61</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; D8..DF</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x71</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x67</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2D</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x09</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5B</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; E0..E7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xCB</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x9B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x25</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xBE</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE5</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6C</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x52</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; E8..EF</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0x59</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xA6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x74</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xD2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xE6</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xF4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB4</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC0</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; F0..F7</span>
  <span style='color:#004a43;'>db</span>   <span style='color:#008000;'>0xD1</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x66</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xAF</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x39</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4B</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x63</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xB6</span><span style='color:#808030;'>,</span>   <span style='color:#696969;'>; F8..FF</span>
</pre>

<strong>Key mixing</strong>

<p>Key mixing or whitening improves resistance to brute force attacks. It involves an exclusive OR operation on the data being encrypted using subkeys derived from the master key.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>static</span> <span style='color:#800000;font-weight:bold;'>void</span> kuz_whiten<span style='color:#808030;'>(</span>w128_t <span style='color:#808030;'>*</span>w<span style='color:#808030;'>,</span> kuz_key_t <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> idx<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
  <span style='color:#800000;font-weight:bold;'>int</span> i<span style='color:#800080;'>;</span>
  uint32_t <span style='color:#808030;'>*</span>p<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint32_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span><span style='color:#808030;'>&amp;</span>key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>k<span style='color:#808030;'>[</span>idx<span style='color:#808030;'>]</span><span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>4</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>w<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> p<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<h3><strong>x86 assembly</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; key whitening</span>
<span style='color:#696969;'>; esi = w</span>
<span style='color:#696969;'>; edi = key</span>
<span style='color:#696969;'>; edx = round</span>
<span style='color:#e34adc;'>kuz_whiten:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span>
    <span style='color:#800000;font-weight:bold;'>shl</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
<span style='color:#e34adc;'>w_l0:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; get 4 bytes of key</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>         <span style='color:#696969;'>; xor state</span>
    <span style='color:#800000;font-weight:bold;'>cmpsd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>w_l0</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Linear layer</strong>

<p>Think of the linear transformation in Serpent, the MixColumns module in Rijndael or the Maximum Distance Seperable code in Twofish. They all serve the same purpose which is to create diffusion. In Diffusion, the statistical structure of the plaintext is dissipated into long range statistics of the cipher text. This is achieved by having each plaintext digit affect the value of many cipher text digits. Which is equivalent to saying that each cipher text digit is affected by many plaintext digits.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// poly multiplication mod p(x) = x^8 + x^7 + x^6 + x + 1</span>
<span style='color:#696969;'>// totally not constant time</span>
<span style='color:#800000;font-weight:bold;'>static</span> uint8_t kuz_mul_gf256<span style='color:#808030;'>(</span>uint8_t x<span style='color:#808030;'>,</span> uint8_t y<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
  uint8_t z<span style='color:#800080;'>;</span>

  z <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>

  <span style='color:#800000;font-weight:bold;'>while</span> <span style='color:#808030;'>(</span>y<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>y <span style='color:#808030;'>&amp;</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      z <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> x<span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    x <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>x <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> <span style='color:#808030;'>(</span>x <span style='color:#808030;'>&amp;</span> <span style='color:#008000;'>0x80</span> <span style='color:#800080;'>?</span> <span style='color:#008000;'>0xC3</span> <span style='color:#800080;'>:</span> <span style='color:#008000;'>0x00</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    y <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
  <span style='color:#800000;font-weight:bold;'>return</span> z<span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>

<span style='color:#800000;font-weight:bold;'>static</span> <span style='color:#800000;font-weight:bold;'>void</span> kuz_lt <span style='color:#808030;'>(</span>w128_t <span style='color:#808030;'>*</span>w<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
  <span style='color:#800000;font-weight:bold;'>int</span>     i<span style='color:#808030;'>,</span> j<span style='color:#800080;'>;</span>
  uint8_t x<span style='color:#800080;'>;</span>

  <span style='color:#696969;'>// Linear vector from sect 5.1.2</span>
  <span style='color:#800000;font-weight:bold;'>const</span> uint8_t kuz_lvec<span style='color:#808030;'>[</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#800080;'>{</span>
    <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFB</span><span style='color:#808030;'>,</span>
    <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>

  <span style='color:#696969;'>// 16 rounds</span>
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span>
  <span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> KUZ_ENCRYPT<span style='color:#808030;'>)</span>
    <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// An LFSR with 16 elements from GF(2^8)</span>
      x <span style='color:#808030;'>=</span> w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> <span style='color:#696969;'>// since lvec[15] = 1</span>

      <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>=</span> <span style='color:#008c00;'>14</span><span style='color:#800080;'>;</span> i <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
        x <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> kuz_mul_gf256<span style='color:#808030;'>(</span>w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> kuz_lvec<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
      w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> x<span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
      x <span style='color:#808030;'>=</span> w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>

      <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i <span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>15</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
        x <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> kuz_mul_gf256<span style='color:#808030;'>(</span>w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> kuz_lvec<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
      w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> x<span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>Peter was able to combine both operations in assembly using ECX (<var>enc</var> flag).</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; linear transformation</span>
<span style='color:#696969;'>; esi = w</span>
<span style='color:#696969;'>; ecx = enc</span>
<span style='color:#e34adc;'>lt_l0:</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; 16 rounds</span>
<span style='color:#e34adc;'>lt_l1:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>15</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>lt_l2</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>

<span style='color:#e34adc;'>lt_l2:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; ah = w-&gt;b[00 or 15]</span>

<span style='color:#e34adc;'>lt_l3:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>bh</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; bh = kuz_lvec[i]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; al = w-&gt;b[i]</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>lt_l4</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>bh</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; bh = kuz_lvec[i]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; al = w-&gt;b[i+1]</span>

<span style='color:#e34adc;'>lt_l4:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>     <span style='color:#696969;'>; w-&gt;b[i] = al</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>kuz_mul_gf256</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>lt_l5</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>15</span>

<span style='color:#e34adc;'>lt_l5:</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>lt_l3</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>     <span style='color:#696969;'>; w-&gt;b[00 or 15] = x</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>lt_l1</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
<span style='color:#e34adc;'>kuz_lt:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>lt_l0</span>
    <span style='color:#004a43;'>db</span> <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span> 
    <span style='color:#004a43;'>db</span> <span style='color:#008000;'>0xC2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xFB</span>
    <span style='color:#004a43;'>db</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC0</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC2</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span>
    <span style='color:#004a43;'>db</span> <span style='color:#008000;'>0x85</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x94</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span>

<span style='color:#696969;'>; poly multiplication </span>
<span style='color:#696969;'>; mod p(x) = x^8 + x^7 + x^6 + x + 1 </span>
<span style='color:#e34adc;'>mgf_l0:</span>
    <span style='color:#800000;font-weight:bold;'>shr</span>    <span style='color:#000080;'>bh</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>1</span>             <span style='color:#696969;'>; if (y &amp; 1), y &gt;&gt;= 1</span>
    <span style='color:#800000;font-weight:bold;'>jnc</span>    <span style='color:#e34adc;'>mgf_l1</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>            <span style='color:#696969;'>; z ^= x</span>
<span style='color:#e34adc;'>mgf_l1:</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>            <span style='color:#696969;'>; if (x &amp; 0x80), x &lt;&lt;= 1</span>
    <span style='color:#800000;font-weight:bold;'>jnc</span>    <span style='color:#e34adc;'>kuz_mul_gf256</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0xC3</span>          <span style='color:#696969;'>; x ^= 0xC3</span>
<span style='color:#e34adc;'>kuz_mul_gf256:</span>
    <span style='color:#800000;font-weight:bold;'>test</span>   <span style='color:#000080;'>bh</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>bh</span>            <span style='color:#696969;'>; while (y)</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>mgf_l0</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<strong>Nonlinear layer</strong>

<p>The purpose of an sbox or substituion box is to obscure the relationship between key and ciphertext - Shannon's property of confusion. Claude E. Shannon proposed ideas related to information security in his 1948 paper <a href="http://netlab.cs.ucla.edu/wiki/files/shannon1949.pdf">Communication Theory of Secrecy Systems</a>. Confusion seeks to make a relationship between the statistics of the cipher text and the value of the encryption key as complex as possible. Even if the attacker can get some handle on the statistics of the cipher text, the way in which the key was used to produce that cipher text is so complex as to make it difficult to deduce the key.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// substitute bytes</span>
<span style='color:#800000;font-weight:bold;'>static</span> <span style='color:#800000;font-weight:bold;'>void</span> kuz_subbytes<span style='color:#808030;'>(</span>w128_t <span style='color:#808030;'>*</span>w<span style='color:#808030;'>,</span> kuz_key_t <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
  <span style='color:#800000;font-weight:bold;'>int</span>           i<span style='color:#800080;'>;</span>
  <span style='color:#800000;font-weight:bold;'>const</span> uint8_t <span style='color:#808030;'>*</span>sbox <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>KUZ_ENCRYPT<span style='color:#808030;'>)</span> <span style='color:#800080;'>?</span> key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>pi <span style='color:#800080;'>:</span> key<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>pi_inv<span style='color:#800080;'>;</span>

  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> sbox<span style='color:#808030;'>[</span>w<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<strong>Key scheduling</strong>

<p>Based on <a href="https://en.wikipedia.org/wiki/Feistel_cipher">Feistel Network</a> design.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#808030;'>/</span> key setup
<span style='color:#800000;font-weight:bold;'>void</span> kuz_setkey<span style='color:#808030;'>(</span>kuz_key_t <span style='color:#808030;'>*</span>kuz<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>const</span> uint8_t key<span style='color:#808030;'>[</span><span style='color:#008c00;'>32</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
  uint32_t i<span style='color:#808030;'>,</span> j<span style='color:#800080;'>;</span>
  w128_t   c<span style='color:#808030;'>,</span> z<span style='color:#800080;'>;</span>
  w256_t   x<span style='color:#800080;'>;</span>

  kuz_init<span style='color:#808030;'>(</span>kuz<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  
  <span style='color:#696969;'>// copy key to context</span>
  <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>kuz<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>k<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

  <span style='color:#696969;'>// copy key to local buffer</span>
  <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
  
  <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>32</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    <span style='color:#696969;'>// C Value</span>
    <span style='color:#603000;'>memset</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>c<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    c<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> i<span style='color:#800080;'>;</span>    <span style='color:#696969;'>// load round in lsb</span>

    kuz_lt<span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>c<span style='color:#808030;'>,</span> KUZ_ENCRYPT<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      z<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span> c<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>

    kuz_subbytes<span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>z<span style='color:#808030;'>,</span> kuz<span style='color:#808030;'>,</span> KUZ_ENCRYPT<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    kuz_lt<span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>z<span style='color:#808030;'>,</span> KUZ_ENCRYPT<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>16</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      z<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>j<span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>+</span>j<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    
    <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>&amp;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>&amp;</span>z<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    
    <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>(</span>i <span style='color:#808030;'>&amp;</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#603000;'>memcpy</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>kuz<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>k<span style='color:#808030;'>[</span><span style='color:#808030;'>(</span>i <span style='color:#808030;'>&gt;</span><span style='color:#808030;'>&gt;</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>)</span><span style='color:#808030;'>]</span><span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>&amp;</span>x<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>Markku's code uses 64-bit values that have been replaced with REP MOVSB operations.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; key setup</span>
<span style='color:#e34adc;'>kuz_setkeyx:</span>
<span style='color:#e34adc;'>_kuz_setkeyx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; ebx=kuz context</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; esi=key</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>32</span>                <span style='color:#696969;'>; eax=32</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>                      <span style='color:#696969;'>; edx=0</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>kuz_init</span>
    
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#696969;'>; copy key to context</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#696969;'>; copy 256-bit key to local buffer</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>                   <span style='color:#696969;'>; allocate 32 bytes for x</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>          <span style='color:#696969;'>; edi=x</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>
    
    <span style='color:#800000;font-weight:bold;'>pushad</span>                   <span style='color:#696969;'>; allocate 32 bytes for c,z</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>          <span style='color:#696969;'>; ebx=z</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>]</span>     <span style='color:#696969;'>; esi=c</span>
    <span style='color:#696969;'>; do 32 rounds</span>
<span style='color:#e34adc;'>ksk_l0:</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span>
    <span style='color:#800000;font-weight:bold;'>ja</span>     <span style='color:#e34adc;'>ksk_l3</span>
    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>                   <span style='color:#696969;'>; save x</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosb</span>             <span style='color:#696969;'>; memset (&amp;c.b[0], 0, 16);</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>15</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>dl</span>      <span style='color:#696969;'>; c.b[15] = i;</span>
    
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esi</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>kuz_lt</span>            <span style='color:#696969;'>; kuz_lt(&amp;c, KUZ_ENCRYPT);</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>

<span style='color:#e34adc;'>ksk_l1:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; al=x.b[j]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>   <span style='color:#696969;'>; ^= c.b[j]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>ksk_l1</span>
    
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>     <span style='color:#696969;'>; XCHG(c, z)</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>     <span style='color:#696969;'>; XCHG(x, kuz)</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>kuz_subbytes</span> <span style='color:#696969;'>; kuz_subbytes(&amp;z, kuz, KUZ_ENCRYPT);</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>kuz_lt</span>       <span style='color:#696969;'>; kuz_lt(&amp;z, KUZ_ENCRYPT);</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>     <span style='color:#696969;'>; XCHG(c, z)</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>     <span style='color:#696969;'>; XCHG(x, kuz)</span>

<span style='color:#e34adc;'>ksk_l2:</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>16</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; z.b[j] ^= x.b[16+j];</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ecx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>16</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>ksk_l2</span>
    
    <span style='color:#696969;'>; memcpy (&amp;x.b[16], &amp;x.b[0], 16);</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    
    <span style='color:#696969;'>; memcpy (&amp;x.b[0], &amp;z.b[0], 16);</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    
    <span style='color:#800000;font-weight:bold;'>test</span>   <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>ksk_l0</span>
    
    <span style='color:#696969;'>; memcpy (&amp;kuz-&gt;k[(i &gt;&gt; 2)].b[0], &amp;x.b[0], 32);</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>            <span style='color:#696969;'>; ecx *= 2</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>movsb</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>ksk_l0</span>
<span style='color:#e34adc;'>ksk_l3:</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Encryption and Decryption</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// encrypt/decrypt a block - 8 bit way</span>
<span style='color:#800000;font-weight:bold;'>void</span> kuz_encrypt<span style='color:#808030;'>(</span>kuz_key_t <span style='color:#808030;'>*</span>key<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>blk<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>int</span> enc<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
  <span style='color:#800000;font-weight:bold;'>int</span>    i<span style='color:#808030;'>,</span> j<span style='color:#800080;'>;</span>
  w128_t <span style='color:#808030;'>*</span>x<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>w128_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>blk<span style='color:#800080;'>;</span>

  <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>enc<span style='color:#808030;'>=</span><span style='color:#808030;'>=</span>KUZ_ENCRYPT<span style='color:#808030;'>)</span>
  <span style='color:#800080;'>{</span>
    i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span><span style='color:#800080;'>;</span><span style='color:#800080;'>;</span><span style='color:#808030;'>)</span>
    <span style='color:#800080;'>{</span>
      kuz_whiten<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> i<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#808030;'>+</span><span style='color:#808030;'>+</span>i <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> KUZ_ROUNDS<span style='color:#808030;'>)</span> <span style='color:#800000;font-weight:bold;'>break</span><span style='color:#800080;'>;</span>
      kuz_subbytes<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> enc<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      kuz_lt<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> enc<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
  <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span>
    i<span style='color:#808030;'>=</span>KUZ_ROUNDS<span style='color:#800080;'>;</span>
    <span style='color:#800000;font-weight:bold;'>for</span> <span style='color:#808030;'>(</span><span style='color:#800080;'>;</span><span style='color:#800080;'>;</span><span style='color:#808030;'>)</span>
    <span style='color:#800080;'>{</span>
      i<span style='color:#808030;'>-</span><span style='color:#808030;'>-</span><span style='color:#800080;'>;</span>
      kuz_whiten<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> i<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>i <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>)</span> <span style='color:#800000;font-weight:bold;'>break</span><span style='color:#800080;'>;</span>
      kuz_lt<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> enc<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      kuz_subbytes<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> key<span style='color:#808030;'>,</span> enc<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
  <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>The assembly takes advantage of similarity between both encryption/decryption operations by storing a pointer to functions in registers and swapping them depending on the <var>enc</var> parameter stored in ecx.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; encrypt/decrypt a block</span>
<span style='color:#e34adc;'>kuz_encryptx:</span>
<span style='color:#e34adc;'>_kuz_encryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span>          <span style='color:#696969;'>; edi=key</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>               <span style='color:#696969;'>; save blk</span>
    <span style='color:#800000;font-weight:bold;'>lodsd</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>                      <span style='color:#696969;'>; edx=0</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>          <span style='color:#696969;'>; ecx=enc</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>esi</span>               <span style='color:#696969;'>; esi=blk</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>load_func</span>
    <span style='color:#696969;'>; kuz_whiten, kuz_subbytes and kuz_lt functions</span>
    <span style='color:#696969;'>; are placed here.</span>
<span style='color:#e34adc;'>load_func:</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>ebx</span> <span style='color:#808030;'>+</span> <span style='color:#808030;'>(</span>kuz_lt <span style='color:#808030;'>-</span> kuz_whiten<span style='color:#808030;'>)</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>ebp</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>eax</span> <span style='color:#808030;'>+</span> <span style='color:#808030;'>(</span>kuz_subbytes <span style='color:#808030;'>-</span> kuz_lt<span style='color:#808030;'>)</span><span style='color:#808030;'>]</span>
    
    <span style='color:#800000;font-weight:bold;'>jecxz</span>  <span style='color:#e34adc;'>kde_l2</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebp</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> KUZ_ROUNDS
    <span style='color:#800000;font-weight:bold;'>jmp</span>    <span style='color:#e34adc;'>kde_l1</span>
<span style='color:#e34adc;'>kde_l0:</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>ebp</span> <span style='color:#696969;'>; kuz_lt or kuz_subbytes</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>eax</span> <span style='color:#696969;'>; kuz_subbytes or kuz_lt</span>
<span style='color:#e34adc;'>kde_l1:</span>
    <span style='color:#800000;font-weight:bold;'>dec</span>    <span style='color:#000080;'>edx</span>
<span style='color:#e34adc;'>kde_l2:</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>ebx</span> <span style='color:#696969;'>; kuz_whiten</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>test</span>   <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>kde_l3</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> KUZ_ROUNDS<span style='color:#808030;'>+</span><span style='color:#008c00;'>1</span>
<span style='color:#e34adc;'>kde_l3:</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>kde_l0</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<p><a href="https://github.com/odzhan/tinycrypt/tree/master/block/kuznyechik">Sources here.</a></p>




