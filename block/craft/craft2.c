
// craft block cipher
// odzhan

#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// sbox
const uint8_t S[16] =
  {0xc ,0xa ,0xd ,0x3 ,0xe ,0xb ,0xf ,0x7 ,0x8 ,0x9 ,0x1 ,0x5 ,0x0 ,0x2 ,0x4 ,0x6 };

// pbox
const uint8_t P[16] =
  {0xf ,0xc ,0xd ,0xe ,0xa ,0x9 ,0x8 ,0xb ,0x6 ,0x5 ,0x4 ,0x7 ,0x1 ,0x2 ,0x3 ,0x0 };

// qbox
const uint8_t Q[16] =
  {0xc ,0xa ,0xf ,0x5 ,0xe ,0x8 ,0x9 ,0x2 ,0xb ,0x3 ,0x7 ,0x4 ,0x6 ,0x0 ,0x1 ,0xd };

// 3-bit lfsr
const uint8_t RC3[32] =
  {0x1 ,0x4 ,0x2 ,0x5 ,0x6 ,0x7 ,0x3 ,0x1 ,0x4 ,0x2 ,0x5 ,0x6 ,0x7 ,0x3 ,0x1 ,0x4 ,
   0x2 ,0x5 ,0x6 ,0x7 ,0x3 ,0x1 ,0x4 ,0x2 ,0x5 ,0x6 ,0x7 ,0x3 ,0x1 ,0x4 ,0x2 ,0x5 };

// 4-bit lfsr
const uint8_t RC4[32] =
  {0x1 ,0x8 ,0x4 ,0x2 ,0x9 ,0xc ,0x6 ,0xb ,0x5 ,0xa ,0xd ,0xe ,0xf ,0x7 ,0x3 ,0x1 ,
   0x8 ,0x4 ,0x2 ,0x9 ,0xc ,0x6 ,0xb ,0x5 ,0xa ,0xd ,0xe ,0xf ,0x7 ,0x3 ,0x1 ,0x8 };

void craft(uint8_t Key[2][16], uint8_t Tweak[16], uint8_t Stt[16]) {
    uint8_t i, j, r, TK[4][16], Temp[16];
    
    for(i = 0; i < 16; i++) {
      TK[0][i] = Key[0][i] ^ Tweak[i];
      TK[1][i] = Key[1][i] ^ Tweak[i];
      TK[2][i] = Key[0][i] ^ Tweak[Q[i]];
      TK[3][i] = Key[1][i] ^ Tweak[Q[i]];
    }
    
    for(r=0;r<32;r++) {
      // MixColumn
      for(i=0; i<4; i++) {   
        Stt[i  ] ^= (Stt[i+ 8] ^ Stt[i+12]);
        Stt[i+4] ^=  Stt[i+12];
      }

      // AddConstant
      Stt[4] ^= RC4[r]; 
      Stt[5] ^= RC3[r];

      // AddTweakey
      for(i=0; i<16; i++) { 
        Stt[i] ^= TK[r % 4][i];
      }
      if(r != 31) {
        // Permutation
        for (i = 0; i < 16; i++) { 
          Temp[P[i]] = Stt[i];
        }
        // SBox
        for(i = 0; i < 16; i++) { 
          Stt[i] = S[Temp[i]];
        }
      }
    }
}

#ifdef TEST
uint8_t tv_key[2][16] = {
  {0x2 ,0x7 ,0xa ,0x6 ,0x7 ,0x8 ,0x1 ,0xa ,0x4 ,0x3 ,0xf ,0x3 ,0x6 ,0x4 ,0xb ,0xc } ,
  {0x9 ,0x1 ,0x6 ,0x7 ,0x0 ,0x8 ,0xd ,0x5 ,0xf ,0xb ,0xb ,0x5 ,0xa ,0xe ,0xf ,0xe }};

uint8_t tv_tweak[16] =
  {0x5 ,0x4 ,0xc ,0xd ,0x9 ,0x4 ,0xf ,0xf ,0xd ,0x0 ,0x6 ,0x7 ,0x0 ,0xa ,0x5 ,0x8 };

uint8_t tv_plain[16] =
  {0x5 ,0x7 ,0x3 ,0x4 ,0xf ,0x0 ,0x0 ,0x6 ,0xd ,0x8 ,0xd ,0x8 ,0x8 ,0xa ,0x3 ,0xe };
  
int main (void) {
    int     i;
    uint8_t data[16];
    
    memcpy(data, tv_plain, 16);
    craft(tv_key, tv_tweak, data);
    
    for(i=0;i<16;i+=2) {
      printf(" %02x", (uint8_t)(data[i] << 4 | data[i+1]));
    }
    putchar('\n');
    return 0;
}
#endif
