<h3><strong>Introduction</strong></h3>

<p><a href="https://iacr.org/archive/ches2006/04/04.pdf">HIGHT</a> which stands for <strong>HIGh security and light weigHT</strong> is a 64-bit block cipher with support for 128-bit keys. It was first proposed at the 2006 <a href="https://iacr.org/archive/ches2006/ches2006.html">Cryptographic Hardware and Embedded Systems</a> (CHES) conference held in Japan. HIGHT attracted a lot of attention upon its release because it only uses add-rotate-xor (ARX) operations on 8-bit words. It was selected in 2010 by the <a href="http://www.tta.or.kr/English/">Telecommunications Technology Association</a> (TTA) of Korea to become part of the <a href="https://www.iso.org/standard/54531.html">ISO/IEC 18033-3</a> portfolio that also consists of the following 64-bit block ciphers: TDEA, MISTY1, CAST-128. Some points to note:</p>

<strong><ul>
	<li>64-bit input/output data block size</li>
	<li>128-bit key length</li>
	<li>32-rounds using 2**8 modular addition, rotation, and XOR (ARX)</li>
	<li>No S-Box (non-linear operations using modular addition)</li>
	<li>Designed for low-resource device (data storage, power, etc.)</li>
</ul></strong>


<h3><strong>Constant Generation</strong></h3>

<p>"Random" constants are used in the generation of subkeys. These are to protect the cipher against simple Slide Attacks. I've included the option of using a lookup table or function to calculate the constants at runtime.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>// use lookup table for constants</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>ifdef</span><span style='color:#004a43;'> LUT</span>
uint8_t rc<span style='color:#808030;'>[</span><span style='color:#008c00;'>128</span><span style='color:#808030;'>]</span><span style='color:#808030;'>=</span>
<span style='color:#800080;'>{</span> <span style='color:#008000;'>0x5a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x36</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x06</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x03</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x41</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x60</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x30</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x18</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x66</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x33</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x59</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2c</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x56</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x15</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x65</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x72</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x39</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1c</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x4e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x67</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x73</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x79</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x37</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x5b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x16</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x05</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x42</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x21</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x50</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x28</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x54</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x55</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x75</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7d</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x3e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x17</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x25</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x52</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x29</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x14</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x45</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x62</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x31</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x58</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x76</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x3b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x47</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x63</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x71</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x78</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7c</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x7e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x07</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x43</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x61</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x70</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x38</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x77</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x7b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1e</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x4f</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x27</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x53</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x69</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x34</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x1a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x4d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x26</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x13</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x49</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x24</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x12</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x09</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x04</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x02</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x01</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x40</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x20</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x10</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x08</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x44</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x22</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x11</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x48</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x64</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x32</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x19</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x0c</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x46</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x23</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x51</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x68</span><span style='color:#808030;'>,</span>
  <span style='color:#008000;'>0x74</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x3a</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5d</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x2e</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x57</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x6b</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x35</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5a</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>else</span>

<span style='color:#800000;font-weight:bold;'>void</span> gen_const<span style='color:#808030;'>(</span>uint8_t <span style='color:#808030;'>*</span>ci<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>int</span>     i<span style='color:#808030;'>,</span> j<span style='color:#800080;'>;</span>
    uint8_t c<span style='color:#800080;'>;</span>
    
    <span style='color:#800000;font-weight:bold;'>union</span> <span style='color:#800080;'>{</span>
      uint8_t  b<span style='color:#808030;'>[</span><span style='color:#008c00;'>128</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      uint32_t w<span style='color:#808030;'>[</span><span style='color:#808030;'>(</span><span style='color:#008c00;'>128</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span><span style='color:#808030;'>/</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span> s<span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// zero initialize s</span>
    <span style='color:#603000;'>memset</span><span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>s<span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span><span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>sizeof</span><span style='color:#808030;'>(</span>s<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// set initial bits</span>
    s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#008c00;'>65537</span><span style='color:#800080;'>;</span>
    s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> s<span style='color:#808030;'>.</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// set first constant</span>
    <span style='color:#696969;'>// precalculated from bits of s array</span>
    ci<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> <span style='color:#008000;'>0x5A</span><span style='color:#800080;'>;</span>

    <span style='color:#800000;font-weight:bold;'>for</span><span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>128</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      c <span style='color:#808030;'>=</span> s<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span>
          s<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>-</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>

      s<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> c<span style='color:#800080;'>;</span>

      <span style='color:#800000;font-weight:bold;'>for</span><span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>1</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>7</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        c <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> c<span style='color:#800080;'>;</span>
        c <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> s<span style='color:#808030;'>.</span>b<span style='color:#808030;'>[</span>i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>6</span> <span style='color:#808030;'>-</span> j<span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
      <span style='color:#800080;'>}</span>
      ci<span style='color:#808030;'>[</span>i<span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> c<span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
<span style='color:#004a43;'>#</span><span style='color:#004a43;'>endif</span>
</pre>

<p>The assembly code is less than 128 bytes, which is used instead of a precomputed array.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>gen_constx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edi</span> <span style='color:#696969;'>; esi = ci</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>80h</span> <span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span> <span style='color:#696969;'>; allocate 136 bytes</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>esp</span>
    <span style='color:#696969;'>; memset(&amp;s, 0, sizeof(s));</span>
    <span style='color:#800000;font-weight:bold;'>rep</span>    <span style='color:#800000;font-weight:bold;'>stosb</span>
    <span style='color:#696969;'>; s.w[1] = 65537;</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>65537</span>
    <span style='color:#696969;'>; s.w[0] = s.w[1] &lt;&lt; 8;</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#800000;font-weight:bold;'>dword</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>65537</span> <span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&lt;</span> <span style='color:#008c00;'>8</span>
    <span style='color:#696969;'>; ci[0] = 0x5A;</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#800000;font-weight:bold;'>byte</span><span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#008000;'>0x5A</span>
    <span style='color:#696969;'>; i = 1;</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>eax</span>
<span style='color:#e34adc;'>gen_l1:</span>
    <span style='color:#696969;'>; c = s.b[i+2] ^ s.b[i-1];</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; s.b[i+6] = c</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#696969;'>; j = 1</span>
    <span style='color:#800000;font-weight:bold;'>cdq</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
<span style='color:#e34adc;'>gen_l2:</span>
    <span style='color:#696969;'>; c += c</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#696969;'>; c ^= s.b[(i + 6) - j];</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>  
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; j++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>gen_l2</span>
    <span style='color:#696969;'>; ci[i] = c;</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
    <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; i&lt;128</span>
    <span style='color:#800000;font-weight:bold;'>jns</span>    <span style='color:#e34adc;'>gen_l1</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>esp</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#000080;'>eax</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>   
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Key Schedule</strong></h3>

<p>The master key is expanded from 128-bits to 1024-bits. Each byte of the master key, indexed using an unexplained calculation, is added to 1 of the generated constants.</p>
 
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> hight128_setkey<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>in<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>out<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    uint8_t i<span style='color:#808030;'>,</span> j<span style='color:#808030;'>,</span> idx<span style='color:#800080;'>;</span>
    w128_t  <span style='color:#808030;'>*</span>wk<span style='color:#808030;'>,</span> <span style='color:#808030;'>*</span>mk<span style='color:#800080;'>;</span>
    uint8_t <span style='color:#808030;'>*</span>sk<span style='color:#800080;'>;</span>
    
    mk<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>w128_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>in<span style='color:#800080;'>;</span>
    wk<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>w128_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>out<span style='color:#800080;'>;</span>
    sk<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint8_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>out<span style='color:#800080;'>;</span>
    
    <span style='color:#696969;'>// apply key whitening</span>
    wk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> mk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    wk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>=</span> mk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>w<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>

<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>ifdef</span><span style='color:#004a43;'> LUT</span>
      <span style='color:#603000;'>memcpy</span><span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>sk<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> rc<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>sizeof</span><span style='color:#808030;'>(</span>rc<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>else</span><span style='color:#004a43;'>  </span>
      <span style='color:#696969;'>// generate constants</span>
      gen_const<span style='color:#808030;'>(</span><span style='color:#808030;'>&amp;</span>sk<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#004a43;'>&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#004a43;'>#</span><span style='color:#004a43;'>endif</span>
 
    <span style='color:#696969;'>// generate subkeys</span>
    <span style='color:#800000;font-weight:bold;'>for</span><span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      sk <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> <span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span>
      <span style='color:#800000;font-weight:bold;'>for</span><span style='color:#808030;'>(</span>j<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>8</span><span style='color:#800080;'>;</span> j<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
        idx <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>j <span style='color:#808030;'>-</span> i <span style='color:#808030;'>+</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>&amp;</span> <span style='color:#008c00;'>7</span><span style='color:#800080;'>;</span>

        sk<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> mk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>idx  <span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
        sk<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> mk<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span>idx<span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
        sk<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#800080;'>;</span>        
      <span style='color:#800080;'>}</span>
    <span style='color:#800080;'>}</span>
<span style='color:#800080;'>}</span>
</pre>

<p>There may be a way to implement generation of the subkeys in 1 loop. The calculation of idx currently requires 2 loops.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#e34adc;'>hight128_setkeyx:</span>    
<span style='color:#e34adc;'>_hight128_setkeyx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; esi = in</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; edi = out    </span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>*</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#696969;'>; i=0</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ecx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>    
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>gen_constx</span>
<span style='color:#e34adc;'>sk_l1:</span>
    <span style='color:#696969;'>; j=0</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
<span style='color:#e34adc;'>sk_l2:</span>
    <span style='color:#696969;'>; idx = ((j + 8) - i) &amp; 7;</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>sub</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>and</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#696969;'>; sk[0] += mk-&gt;b[idx  ];</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; sk[8] += mk-&gt;b[idx+8];</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; sk++;</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edi</span>
    <span style='color:#696969;'>; j++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>edx</span>
    <span style='color:#696969;'>; j&lt;8</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>sk_l2</span>
    <span style='color:#696969;'>; sk += 8</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>edx</span>
    <span style='color:#696969;'>; i++</span>
    <span style='color:#800000;font-weight:bold;'>inc</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#696969;'>; i&lt;8</span>
    <span style='color:#800000;font-weight:bold;'>cmp</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>jnz</span>    <span style='color:#e34adc;'>sk_l1</span>    
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<h3><strong>Round functions</strong></h3>

<p>2 Linear functions which provide diffusion. Although they're shown separately here, a different version inlines them in the main encryption loop.</p>

<pre style='color:#000000;background:#ffffff;'>uint8_t F0<span style='color:#808030;'>(</span>uint8_t x<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>return</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>1</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>2</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>

uint8_t F1<span style='color:#808030;'>(</span>uint8_t x<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>return</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> ROTL8<span style='color:#808030;'>(</span>x<span style='color:#808030;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

<h3><strong>Encryption</strong></h3>

<p>The only nonlinear operations here are the modular addition. Perhaps it would have made more sense to use an s-box layer. A 4 x 4 bit-slice sbox would work well here.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>void</span> hight128_encrypt<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>data<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>void</span> <span style='color:#808030;'>*</span>keys<span style='color:#808030;'>)</span>
<span style='color:#800080;'>{</span>
    <span style='color:#800000;font-weight:bold;'>int</span>      i<span style='color:#800080;'>;</span>
    w64_t    <span style='color:#808030;'>*</span>x<span style='color:#800080;'>;</span>
    uint8_t  <span style='color:#808030;'>*</span>sk<span style='color:#808030;'>,</span> <span style='color:#808030;'>*</span>wk<span style='color:#808030;'>=</span><span style='color:#808030;'>(</span>uint8_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>keys<span style='color:#800080;'>;</span>

    x  <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>w64_t<span style='color:#808030;'>*</span><span style='color:#808030;'>)</span>data<span style='color:#800080;'>;</span>
    sk <span style='color:#808030;'>=</span> <span style='color:#808030;'>&amp;</span>wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>8</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// mix key with 1st 4 bytes</span>
    x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>

    <span style='color:#800000;font-weight:bold;'>for</span><span style='color:#808030;'>(</span>i<span style='color:#808030;'>=</span><span style='color:#008c00;'>0</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>&lt;</span><span style='color:#008c00;'>32</span><span style='color:#800080;'>;</span> i<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span>
      <span style='color:#696969;'>// circular shift left by 8 bits</span>
      x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>q <span style='color:#808030;'>=</span> ROTL64<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>q<span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      <span style='color:#696969;'>// apply linear/non-linear operations</span>
      x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>F1<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> <span style='color:#808030;'>*</span>sk<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>F0<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>3</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> <span style='color:#808030;'>*</span>sk<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>F1<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>5</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>^</span> <span style='color:#808030;'>*</span>sk<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
      x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>F0<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>]</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>+</span> <span style='color:#808030;'>*</span>sk<span style='color:#808030;'>+</span><span style='color:#808030;'>+</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>
    <span style='color:#800080;'>}</span>
    <span style='color:#696969;'>// circular shift right by 8 bits</span>
    x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>q <span style='color:#808030;'>=</span> ROTL64<span style='color:#808030;'>(</span>x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>q<span style='color:#808030;'>,</span> <span style='color:#008c00;'>56</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span>

    <span style='color:#696969;'>// mix key with 2nd 4 bytes</span>
    x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>5</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
    x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>+</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> x<span style='color:#808030;'>-</span><span style='color:#808030;'>&gt;</span>b<span style='color:#808030;'>[</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span> <span style='color:#808030;'>^</span><span style='color:#808030;'>=</span> wk<span style='color:#808030;'>[</span><span style='color:#008c00;'>7</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span>
<span style='color:#800080;'>}</span>
</pre>

<p>The assembly code for this is slightly different from the C code, and wasn't enjoyable to implement ;) For each round, there are 2 loops, consisting of 1 addition and 1 XOR with the linear functions inlined. The 64-bit rotation uses ADD/ADC.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969;'>; rotate cipher text 64-bits    </span>
<span style='color:#e34adc;'>rotl64:</span> 
    <span style='color:#800000;font-weight:bold;'>pushad</span>  
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span>   
<span style='color:#e34adc;'>rt_l0:</span>     
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>eax</span>
    <span style='color:#800000;font-weight:bold;'>adc</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>adc</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>0</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>rt_l0</span>    
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>xchg</span>   <span style='color:#000080;'>eax</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ebx</span>
    <span style='color:#800000;font-weight:bold;'>stosd</span>
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>   
   
<span style='color:#e34adc;'>hight128_encryptx:</span>
<span style='color:#e34adc;'>_hight128_encryptx:</span>
    <span style='color:#800000;font-weight:bold;'>pushad</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>edi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+4</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; data</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>esi</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>esp</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>32</span><span style='color:#008c00;'>+8</span><span style='color:#808030;'>]</span> <span style='color:#696969;'>; wk and sk</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>edi</span>
<span style='color:#e34adc;'>hi_l0:</span>    
    <span style='color:#800000;font-weight:bold;'>lodsw</span>
    <span style='color:#696969;'>; x-&gt;b[0] += wk[0];     </span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; x-&gt;b[2] ^= wk[1];</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#800000;font-weight:bold;'>scasd</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>hi_l0</span>    
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>edi</span>    
    <span style='color:#800000;font-weight:bold;'>lodsd</span>    
    <span style='color:#696969;'>; save wk[4]</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; 32 rounds    </span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>32</span>
<span style='color:#e34adc;'>hi_enc:</span>
    <span style='color:#800000;font-weight:bold;'>push</span>   <span style='color:#000080;'>ecx</span>
    <span style='color:#696969;'>; x-&gt;q = ROTL64(x-&gt;q, 8);</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>8</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>rotl64</span>        
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>movzx</span>  <span style='color:#000080;'>edx</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>cl</span>
<span style='color:#e34adc;'>hi_l1:</span>
    <span style='color:#696969;'>; c = x-&gt;b[j-1];</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>-</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; c = ROTL8(c, 3) ^ ROTL8(c, 4) ^ ROTL8(c, 6);</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>3</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>6</span><span style='color:#008c00;'>-4</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; x-&gt;b[j] += (c ^ *sk++);</span>
    <span style='color:#800000;font-weight:bold;'>lodsb</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>    
    <span style='color:#696969;'>; c = x-&gt;b[j+1];</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span>
    <span style='color:#696969;'>; c = ROTL8(c, 1) ^ ROTL8(c, 2) ^ ROTL8(c, 7);</span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>1</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>2</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>rol</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span><span style='color:#008c00;'>-2</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#000080;'>ah</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; x-&gt;b[(j+2) &amp; 7] ^= (c + *sk++);</span>
    <span style='color:#800000;font-weight:bold;'>lodsb</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>al</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#800000;font-weight:bold;'>lea</span>    <span style='color:#000080;'>ebx</span><span style='color:#808030;'>,</span> <span style='color:#808030;'>[</span><span style='color:#000080;'>edx</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span>
    <span style='color:#800000;font-weight:bold;'>and</span>    <span style='color:#000080;'>bl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>7</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#000080;'>ebx</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#000080;'>dl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>4</span>    
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>hi_l1</span>    
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>ecx</span>
    <span style='color:#800000;font-weight:bold;'>loop</span>   <span style='color:#e34adc;'>hi_enc</span>    
    <span style='color:#696969;'>; x-&gt;q = ROTL64(x-&gt;q, 56);   </span>
    <span style='color:#800000;font-weight:bold;'>mov</span>    <span style='color:#000080;'>cl</span><span style='color:#808030;'>,</span> <span style='color:#008c00;'>56</span>
    <span style='color:#800000;font-weight:bold;'>call</span>   <span style='color:#e34adc;'>rotl64</span>    
    <span style='color:#696969;'>; restore wk[4]</span>
    <span style='color:#800000;font-weight:bold;'>pop</span>    <span style='color:#000080;'>eax</span>
    <span style='color:#696969;'>; x-&gt;b[0] += wk[0];     </span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>
    <span style='color:#696969;'>; x-&gt;b[2] ^= wk[1];</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>2</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>
    <span style='color:#800000;font-weight:bold;'>bswap</span>  <span style='color:#000080;'>eax</span>                <span style='color:#696969;'>; instead of shr eax, 16</span>
    <span style='color:#696969;'>; x-&gt;b[4] += wk[6]; </span>
    <span style='color:#800000;font-weight:bold;'>add</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>4</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>ah</span>    
    <span style='color:#696969;'>; x-&gt;b[6] ^= wk[7];</span>
    <span style='color:#800000;font-weight:bold;'>xor</span>    <span style='color:#808030;'>[</span><span style='color:#000080;'>edi</span><span style='color:#808030;'>+</span><span style='color:#008c00;'>6</span><span style='color:#808030;'>]</span><span style='color:#808030;'>,</span> <span style='color:#000080;'>al</span>    
    <span style='color:#800000;font-weight:bold;'>popad</span>
    <span style='color:#800000;font-weight:bold;'>ret</span>
</pre>

<p>I've no doubt the above code can be optimized further, but it would require removing the dependency on EDI in the main loop. The load/save operations using EDI are not necessary except at the beginning and end of code.  If the plaintext was loaded into 2 32-bit registers, there's a possibility of removing the 64-bit rotation in the main loop by rotating registers and swapping bytes.</p>

<h3><strong>Summary</strong></h3>

<p>Because of the linear functions, it's difficult to see how one could optimize it for a 32-bit or 64-bit CPU. I've speculated that if the bytes of plaintext were rearranged, one could optimize it further for a 16-bit CPU, but it would still need 8-bit operations for the linear functions. The assembly code generated by MSVC is approx. 440 bytes and the assembly is currently 283 bytes.</p>

<p><a href="https://github.com/odzhan/tinycrypt/tree/master/block/hight">Sources here.</a></p>
