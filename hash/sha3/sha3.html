<h3><strong>Introduction</strong></h3>

<p><a href="http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf">Keccak</a> is a permutation function designed by <a href="http://dblp.uni-trier.de/pers/hd/b/Bertoni:Guido">Guido Bertoni</a>, <a href="http://jda.noekeon.org/">Joan Daemen</a>, <a href="http://mip.noekeon.org/">MichaÃ«l Peeters</a>, and <a href="http://gva.noekeon.org/">Gilles Van Assche</a>. It was selected by <a href="http://www.nist.gov/itl/csd/201508_sha3.cfm">NIST to become the SHA-3 standard</a> and is a complement to <a href="https://tools.ietf.org/rfc/rfc4634.txt">SHA-2</a> rather than a replacement. Currently, SHA-2 is widely used and not known publicly to have any weaknesses. Since SHA-2 is very similar to <a href="https://tools.ietf.org/rfc/rfc1320.txt">MD4</a>, <a href="https://www.ietf.org/rfc/rfc1321.txt">MD5</a> and <a href="https://tools.ietf.org/rfc/rfc3174.txt">SHA-1</a> in design, weaknesses may be identified in the future and SHA-3 is intended to be a drop in replacement.</p>

<h3><strong>Macros and data types</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> R</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>|</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>v</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>64</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>define</span><span style='color:#004a43; '> F</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>,</span><span style='color:#004a43; '>b</span><span style='color:#808030; '>)</span><span style='color:#004a43; '>for</span><span style='color:#808030; '>(</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>=</span><span style='color:#004a43; '>0</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>&lt;</span><span style='color:#004a43; '>b</span><span style='color:#808030; '>;</span><span style='color:#004a43; '>a</span><span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
  
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>long</span> <span style='color:#800000; font-weight:bold; '>long</span> W<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>char</span> B<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span> _sha3_ctx <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>union</span> <span style='color:#800080; '>{</span>
      B b<span style='color:#808030; '>[</span><span style='color:#008c00; '>200</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
      W q<span style='color:#808030; '>[</span><span style='color:#008c00; '>25</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span> s<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#808030; '>,</span>h<span style='color:#808030; '>,</span>r<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>sha3_ctx<span style='color:#800080; '>;</span>
</pre>

<h3><strong>Initialization</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>void</span> sha3_init<span style='color:#808030; '>(</span>sha3_ctx<span style='color:#808030; '>*</span>c<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>int</span> len<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    W i<span style='color:#800080; '>;</span>
    
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>25</span><span style='color:#808030; '>)</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>.</span>q<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
    
    c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>h <span style='color:#808030; '>=</span> len<span style='color:#800080; '>;</span>
    c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r <span style='color:#808030; '>=</span> <span style='color:#008c00; '>200</span><span style='color:#808030; '>-</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>*</span>len<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>Adding data</strong></h3>

<p>The <a href="http://sponge.noekeon.org/">Sponge construction</a> is used for "absorbing" data into the internal state. Blocks of data are xor'd with the state buffer before being transformed using the permutation function. The authors have this to say.</p>

<blockquote>the sponge construction is a mode of operation, based on a fixed-length permutation (or transformation) and on a padding rule, which builds a function mapping variable-length input to variable-length output. Such a function is called a sponge function.</blockquote></p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>void</span> sha3_update<span style='color:#808030; '>(</span>sha3_ctx<span style='color:#808030; '>*</span>c<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>in<span style='color:#808030; '>,</span> W len<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    W i<span style='color:#800080; '>;</span>
    B <span style='color:#808030; '>*</span>p<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>B<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>in<span style='color:#800080; '>;</span>
  
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span>len<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
      c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>.</span>b<span style='color:#808030; '>[</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>^</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>*</span>p<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>    
      <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>i <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        P<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
        c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>i<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
      <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>Finalization</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>void</span> sha3_final<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>out<span style='color:#808030; '>,</span> sha3_ctx<span style='color:#808030; '>*</span>c<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    B   <span style='color:#808030; '>*</span>p<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>B<span style='color:#808030; '>*</span><span style='color:#808030; '>)</span>out<span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>int</span> i<span style='color:#800080; '>;</span>
    
    c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>.</span>b<span style='color:#808030; '>[</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>6</span><span style='color:#800080; '>;</span>
    c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>.</span>b<span style='color:#808030; '>[</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>r<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span><span style='color:#008000; '>0x80</span><span style='color:#800080; '>;</span>
    P<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>h<span style='color:#808030; '>)</span>p<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>c<span style='color:#808030; '>-</span><span style='color:#808030; '>></span>s<span style='color:#808030; '>.</span>b<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre>

<h3><strong>Compression</strong></h3>

<pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>void</span> P<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>void</span><span style='color:#808030; '>*</span>p<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    W n<span style='color:#808030; '>,</span>i<span style='color:#808030; '>,</span>j<span style='color:#808030; '>,</span>r<span style='color:#808030; '>,</span>x<span style='color:#808030; '>,</span>y<span style='color:#808030; '>,</span>t<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>,</span>b<span style='color:#808030; '>[</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span><span style='color:#808030; '>*</span>s<span style='color:#808030; '>=</span>p<span style='color:#800080; '>;</span>
    B c<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>

    F<span style='color:#808030; '>(</span>n<span style='color:#808030; '>,</span><span style='color:#008c00; '>24</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
      F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>b<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span>b<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>s<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span><span style='color:#800080; '>}</span>
      F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
        t<span style='color:#808030; '>=</span>b<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span>R<span style='color:#808030; '>(</span>b<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>63</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span>s<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>=</span>t<span style='color:#800080; '>;</span><span style='color:#800080; '>}</span>
      t<span style='color:#808030; '>=</span>s<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>y<span style='color:#808030; '>=</span>r<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>x<span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
      F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>24</span><span style='color:#808030; '>)</span>
        r<span style='color:#808030; '>+</span><span style='color:#808030; '>=</span>j<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>Y<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>x<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>y<span style='color:#808030; '>*</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>x<span style='color:#808030; '>=</span>y<span style='color:#808030; '>,</span>y<span style='color:#808030; '>=</span>Y<span style='color:#808030; '>%</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>,</span>
        Y<span style='color:#808030; '>=</span>s<span style='color:#808030; '>[</span>x<span style='color:#808030; '>+</span>y<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>s<span style='color:#808030; '>[</span>x<span style='color:#808030; '>+</span>y<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>R<span style='color:#808030; '>(</span>t<span style='color:#808030; '>,</span> <span style='color:#808030; '>-</span>r<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>t<span style='color:#808030; '>=</span>Y<span style='color:#800080; '>;</span>
      F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>{</span>
        F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span>b<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>s<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
        F<span style='color:#808030; '>(</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span>
          s<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>=</span>b<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span> b<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>~</span> b<span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>%</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span><span style='color:#800080; '>}</span>
      F<span style='color:#808030; '>(</span>j<span style='color:#808030; '>,</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>^</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>></span><span style='color:#808030; '>></span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>113</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>&amp;</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span>
          <span style='color:#808030; '>*</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#006600; '>ULL</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span>j<span style='color:#808030; '>)</span><span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
</pre>

<p><a href="https://github.com/odzhan/tinycrypt/tree/master/hash/sha3">Sources here.</a></p>
